{% extends "base.html" %}

{% block title %}Eficiencia de Empaque - Formato Excel{% endblock %}

{% block page_title %}Ejercicio de Eficiencia #{{ exercise.id }}{% endblock %}

{% block extra_styles %}
<style>
    .excel-container {
        background-color: white;
        border-radius: 12px;
        padding: 2rem;
        margin-bottom: 2rem;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    }
    
    .excel-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid #eee;
    }
    
    .excel-title {
        margin: 0;
        font-weight: 600;
        color: var(--pepsico-blue);
    }
    
    .back-link {
        color: var(--pepsico-blue);
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        font-weight: 500;
        font-size: 0.9rem;
        margin-bottom: 1rem;
    }
    
    .back-link i {
        margin-right: 0.25rem;
    }
    
    .excel-info {
        background-color: #f8f9fa;
        border-radius: 10px;
        padding: 1.5rem;
        margin-bottom: 2rem;
    }
    
    .info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 1rem;
    }
    
    .info-item {
        background-color: white;
        border-radius: 8px;
        padding: 1rem;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }
    
    .info-label {
        color: #6c757d;
        font-size: 0.8rem;
        margin-bottom: 0.25rem;
    }
    
    .info-value {
        font-weight: 600;
        font-size: 1.1rem;
        color: var(--pepsico-blue);
    }
    
    /* Estilos mejorados para las tablas de Excel */
    .capture-table-container {
        margin-bottom: 30px;
        background-color: white;
        border-radius: 10px;
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.08);
        overflow: hidden;
        transition: all 0.3s ease;
    }
    
    .capture-table-container:hover {
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
        transform: translateY(-3px);
    }
    
    .capture-title {
        padding: 1rem 1.5rem;
        margin: 0;
        background: linear-gradient(90deg, #0057a8 0%, #3984c9 100%);
        color: white;
        font-weight: 600;
        font-size: 1.1rem;
        text-shadow: 0 1px 2px rgba(0,0,0,0.2);
        border-radius: 10px 10px 0 0;
    }
    
    .table {
        margin-bottom: 0;
    }
    
    .table-bordered {
        border: 1px solid #dee2e6;
    }
    
    .table thead th {
        font-weight: 600;
        vertical-align: middle;
        background-color: #f8f9fa;
        border-bottom: 2px solid #dee2e6;
        color: #495057;
        text-align: center;
        padding: 0.75rem 0.5rem;
        font-size: 0.9rem;
        height: 50px;
    }
    
    .table tbody td {
        vertical-align: middle;
        padding: 0.5rem;
        height: 48px;
    }
    
    .table .form-control {
        border: none;
        padding: 0.375rem 0.5rem;
        height: calc(100% - 2px);
        width: 100%;
        background-color: transparent;
        transition: all 0.2s;
        text-align: center;
        font-size: 0.95rem;
    }
    
    .table .form-control:focus {
        background-color: rgba(0, 87, 168, 0.05);
        box-shadow: none;
        outline: 2px solid rgba(0, 87, 168, 0.3);
    }
    
    .table .form-control:read-only {
        background-color: #f8f9fa;
        color: #495057;
        cursor: default;
    }
    
    /* Colores personalizados para campos específicos */
    td[style*="background-color: #cfe2ff"] .form-control {
        background-color: #cfe2ff;
        color: #084298;
        font-weight: 500;
    }
    
    td[style*="background-color: #f8d7da"] .form-control {
        background-color: #f8d7da;
        color: #842029;
        font-weight: 500;
    }
    
    td[style*="background-color: #fff3cd"] .form-control {
        background-color: #fff3cd;
        color: #664d03;
        font-weight: 500;
    }
    
    /* Mejoras estéticas para los botones y acciones */
    .btn-action {
        border-radius: 50px;
        padding: 0.5rem 1.25rem;
        font-weight: 500;
        transition: all 0.3s;
    }
    
    .btn-action:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    
    .delete-capture {
        border-radius: 6px;
        font-size: 0.85rem;
        transition: all 0.2s ease;
        margin-bottom: 1rem;
        margin-right: 1rem;
    }
    
    .delete-capture:hover {
        background-color: #dc3545;
        color: white;
    }
    
    .table-controls {
        margin-bottom: 20px;
    }
    
    #addCapture {
        background: linear-gradient(45deg, #0057a8 0%, #3984c9 100%);
        border: none;
        padding: 0.6rem 1.25rem;
        font-weight: 500;
        border-radius: 6px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        transition: all 0.3s;
    }
    
    #addCapture:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        transform: translateY(-2px);
    }
    
    #addCapture:active {
        transform: translateY(1px);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    .table-responsive {
        border-radius: 10px;
        overflow: hidden;
    }
    
    /* Estilos para encabezados de tabla */
    .excel-header-row th {
        background: linear-gradient(to bottom, #f8f9fa, #e9ecef);
        color: #495057;
        font-weight: 600;
        text-align: center;
        padding: 12px 8px;
        border: 1px solid #dee2e6;
        border-bottom: 2px solid #0057a8;
        text-transform: uppercase;
        font-size: 0.8rem;
        letter-spacing: 0.5px;
    }
    
    /* Colores específicos para columnas importantes */
    th[style*="background-color"] {
        position: relative;
    }
    
    th[style*="background-color: #cfe2ff"] {
        color: #084298;
        background: linear-gradient(to bottom, #cfe2ff, #b6d4fe) !important;
    }
    
    th[style*="background-color: #f8d7da"] {
        color: #842029;
        background: linear-gradient(to bottom, #f8d7da, #f5c2c7) !important;
    }
    
    th[style*="background-color: #fff3cd"] {
        color: #664d03;
        background: linear-gradient(to bottom, #fff3cd, #ffecb5) !important;
    }
    
    /* Efectos al pasar el mouse sobre filas */
    tbody tr:hover {
        background-color: rgba(0, 0, 0, 0.01);
    }
</style>
{% endblock %}

{% block content %}
<a href="{{ url_for('eff_empaque') }}" class="back-link">
    <i class="fas fa-arrow-left"></i> Volver a Lista de Ejercicios
</a>

<div class="excel-container">
    <div class="excel-header">
        <h4 class="excel-title">
            <i class="fas fa-file-excel me-2"></i>Ejercicio de Eficiencia #{{ exercise.id }}
        </h4>
        
        <div>
            <a href="{{ url_for('view_eff_empaque', exercise_id=exercise.id) }}" class="btn btn-light me-2">
                <i class="fas fa-eye me-1"></i> Ver Resumen
            </a>
        </div>
    </div>
    
    <div class="excel-info">
        <div class="info-grid">
            <div class="info-item">
                <div class="info-label">Unidad de Negocio</div>
                <div class="info-value">{{ exercise.bu.name if exercise.bu else 'N/A' }}</div>
            </div>
            <div class="info-item">
                <div class="info-label">Planta</div>
                <div class="info-value">{{ exercise.plant.name if exercise.plant else 'N/A' }}</div>
            </div>
            <div class="info-item">
                <div class="info-label">Fecha de Creación</div>
                <div class="info-value">{{ exercise.created_at.strftime('%d/%m/%Y') }}</div>
            </div>
            <div class="info-item">
                <div class="info-label">Última Actualización</div>
                <div class="info-value">{{ exercise.updated_at.strftime('%d/%m/%Y') }}</div>
            </div>
        </div>
    </div>
    
    <div class="excel-section">
        <div class="excel-section-title">
            <div class="excel-section-icon">
                <i class="fas fa-table"></i>
            </div>
            Datos del Ejercicio (Formato Excel)
        </div>
        
        <div class="legend">
            <div class="legend-item">
                <div class="legend-color" style="background-color: #fff;"></div>
                <span>Celdas editables</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #f5f5f5;"></div>
                <span>Celdas calculadas automáticamente</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #bbdefb;"></div>
                <span>Títulos principales</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #c8e6c9;"></div>
                <span>Resultados</span>
            </div>
        </div>
        
        <div class="table-controls">
            <button type="button" id="addCapture" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#newCaptureModal">
            <i class="fas fa-plus-circle me-2"></i> Agregar Nueva Captura
            </button>
        </div>

        <!-- Modal Nueva Captura -->
        <div class="modal fade" id="newCaptureModal" tabindex="-1" aria-labelledby="newCaptureModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <form id="newCaptureForm" method="POST" action="{{ url_for('add_capture_eff_empaque', exercise_id=exercise.id) }}">
                <div class="modal-header">
                    <h5 class="modal-title" id="newCaptureModalLabel">
                    <i class="fas fa-plus-circle me-2"></i> Nueva Captura
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body">
                    <div class="row g-3">
                    <div class="col-md-6">
                        <label for="sabor" class="form-label">Sabor</label>
                        <select class="form-select" id="sabor" name="sabor" required>
                            <option value="">Seleccione...</option>
                            {% for flavor in flavors %}
                                <option value="{{ flavor.name }}">{{ flavor.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label for="tubo" class="form-label">Tubo</label>
                        <input type="text" class="form-control" id="tubo" name="tubo" required>
                    </div>
                    <div class="col-md-4">
                        <label for="peso_gr" class="form-label">Peso</label>
                        <input type="number" step="0.01" class="form-control" id="peso_gr" name="peso_gr" required>
                    </div>
                    <div class="col-md-4">
                        <label for="bpm_actual" class="form-label">BPM Actual</label>
                        <input type="number" step="0.01" class="form-control" id="bpm_actual" name="bpm_actual" required>
                    </div>
                    <div class="col-md-4">
                        <label for="tiempo" class="form-label">Tiempo</label>
                        <input type="number" step="0.01" class="form-control" id="tiempo" name="tiempo" required>
                    </div>
                    <div class="col-md-3">
                        <label for="total_pq" class="form-label">Total PQ</label>
                        <input type="number" step="1" class="form-control" id="total_pq" name="total_pq" required>
                    </div>
                    <div class="col-md-3">
                        <label for="total_pq_buenos" class="form-label">Total PQ Buenos</label>
                        <input type="number" step="1" class="form-control" id="total_pq_buenos" name="total_pq_buenos" required>
                    </div>
                    <div class="col-md-3">
                        <label for="bpm_propuesta" class="form-label">BPM Propuesta</label>
                        <input type="number" step="1" class="form-control" id="bpm_propuesta" name="bpm_propuesta" required>
                    </div>
                    <div class="col-md-3">
                        <label for="bpm_global" class="form-label">BPM Global</label>
                        <input type="number" step="1" class="form-control" id="bpm_global" name="bpm_global" required>
                    </div>
                    <div class="col-md-4">
                        <label for="seasoning" class="form-label">Seasoning</label>
                        <input type="number" step="0.01" class="form-control" id="seasoning" name="seasoning" required>
                    </div>
                    <div class="col-md-4">
                        <label for="eff_std_empaque" class="form-label">Eff STD Empaque</label>
                        <input type="number" step="1" class="form-control" id="eff_std_empaque" name="eff_std_empaque" required>
                    </div>
                    <div class="col-md-4">
                        <label for="mejora_propuesta" class="form-label">Mejora Propuesta</label>
                        <input type="number" step="1" class="form-control" id="mejora_propuesta" name="mejora_propuesta" required>
                    </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Agregar Captura</button>
                </div>
                </form>
            </div>
            </div>
        </div>
        
        <div class="table-responsive">
            <div id="capturesContainer">
                <!-- Resumen de datos -->
                <div class="capture-table-container" style="margin-bottom: 20px; box-shadow: 0 4px 16px rgba(76, 175, 80, 0.08);">
                    <div class="capture-title">
                        <i class="fas fa-chart-bar me-2"></i> Resumen Promedios del Ejercicio
                    </div>
                    <table class="table table-bordered table-striped align-middle mb-0" style="background-color: #f1f8e9;">
                        <thead>
                            <tr class="excel-header-row" style="background: linear-gradient(90deg, #0057a8 0%, #3984c9 100%); color: #fff; font-weight: 600; text-align: center;">
                                <th style="background: none; color: #fff;">Eff STD Empaque</th>
                                <th style="background: none; color: #fff;">Eff Actual Empaque</th>
                                <th style="background: none; color: #fff;">Mejora Propuesta</th>
                                <th style="background: none; color: #fff;">Eff Propuesta</th>
                                <th style="background: none; color: #fff;">STD PT(kg/hr)</th>
                                <th style="background: none; color: #fff;">Actual PT(Kg/hr)</th>
                                <th style="background: none; color: #fff;">Propuesta PT(Kg/hr)</th>
                                <th style="background: none; color: #fff;">Global PT(Kg/hr)</th>
                                <th style="background: none; color: #fff;">Desperdicio</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr style="background-color: #c8e6c9; font-weight: bold; color: #1b5e20; text-align: center; font-size: 1.1rem;">
                                <td style="background-color: #c8e6c9; color: #1b5e20;">{{ averages.eff_std_empaque|round(1) }}</td>
                                <td style="background-color: #c8e6c9; color: #1b5e20;">{{ averages.eff_actual_empaque|round(1) }} %</td>
                                <td style="background-color: #c8e6c9; color: #1b5e20;">{{ averages.mejora_propuesta|round(1) }}</td>
                                <td style="background-color: #c8e6c9; color: #1b5e20;">{{ averages.eff_propuesta|round(1) }} %</td>
                                <td style="background-color: #c8e6c9; color: #1b5e20;">{{ averages.std_pt|round(1) }}</td>
                                <td style="background-color: #c8e6c9; color: #1b5e20;">{{ averages.actual_pt|round(1) }}</td>
                                <td style="background-color: #c8e6c9; color: #1b5e20;">{{ averages.propuesta_pt|round(1) }}</td>
                                <td style="background-color: #c8e6c9; color: #1b5e20;">{{ averages.global_pt|round(1) }}</td>
                                <td style="background-color: #f8d7da; color: #842029;">{{ averages.desperdicio|round(1) }}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <br>
                <!-- Tabla de capturas -->
                <div class="capture-table-container">
                    <div class="capture-title">
                        <i class="fas fa-database me-2"></i> Capturas Registradas
                    </div>
                    <table class="table table-bordered table-striped align-middle mb-0">
                        <thead>
                            <tr class="excel-header-row" style="background: linear-gradient(90deg, #0057a8 0%, #3984c9 100%); color: #fff;">
                                <th style="background: none; color: #fff;">Acciones</th>
                                <th style="background: none; color: #fff;">Sabor</th>
                                <th style="background: none; color: #fff;">Tubo</th>
                                <th style="background: none; color: #fff;">Peso</th>
                                <th style="background: none; color: #fff;">BPM Actual</th>
                                <th style="background: none; color: #fff;">Tiempo</th>
                                <th style="background: none; color: #fff;">Total PQ</th>
                                <th style="background: none; color: #fff;">Total PQ Buenos</th>
                                <th style="background: none; color: #fff;">BPM Propuesta</th>
                                <th style="background: none; color: #fff;">BPM Global</th>
                                <th style="background: none; color: #fff;">Seasoning</th>
                                <th style="background: none; color: #fff;">Eff STD Empaque</th>
                                <th style="background: none; color: #fff;">PQ Global</th>
                                <th style="background: none; color: #fff;">Eff Actual Empaque</th>
                                <th style="background: #c8e6c9; color: #1b5e20;">Mejora Propuesta</th>
                                <th style="background: none; color: #fff;">Eff Propuesta</th>
                                <th style="background: none; color: #fff;">STD PT(kg/hr)</th>
                                <th style="background: none; color: #fff;">Actual PT(Kg/hr)</th>
                                <th style="background: none; color: #fff;">Propuesta PT(Kg/hr)</th>
                                <th style="background: none; color: #fff;">Global PT(Kg/hr)</th>
                                <th style="background: none; color: #fff;">Desperdicio</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for capture in data.captures %}
                            <tr>
                                <td style="background-color: #d1e7dd;">
                                    <button 
                                        class="btn btn-danger btn-sm delete-capture" 
                                        onclick="deleteCapture({{ loop.index0 }})"
                                        title="Eliminar captura"
                                        type="button"
                                    >
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                                <td style="background-color: #fff3cd;">{{ capture.sabor }}</td>
                                <td style="background-color: #fff3cd;">{{ capture.tubo }}</td>
                                <td style="background-color: #fff3cd;" class="peso-gr">{{ capture.peso_gr }}</td>
                                <td style="background-color: #fff3cd;" class="bpm-actual">{{ capture.bpm_actual | default(0) | int }}</td>
                                <td style="background-color: #fff3cd;" class="tiempo">{{ capture.tiempo }}</td>
                                <td style="background-color: #fff3cd;">{{ capture.total_pq }}</td>
                                <td style="background-color: #fff3cd;" class="total-pq-buenos">{{ capture.total_pq_buenos }}</td>
                                <td style="background-color: #fff3cd;" class="bpm-propuesta">{{ capture.bpm_propuesta }}</td>
                                <td style="background-color: #fff3cd;" class="bpm-global">{{ capture.bpm_global }}</td>
                                <td style="background-color: #fff3cd;">{{ capture.seasoning }} %</td>
                                <td class="eff-std-empaque" style="background-color: #bbdefb;">{{ capture.eff_std_empaque }}</td>
                                <td style="background-color: #bbdefb;">{{ (capture.tiempo*60*capture.bpm_global) |int }}</td>
                                <td class="eff-actual-empaque" style="background-color: #bbdefb;">
                                    {% if capture.bpm_actual != 0 %}
                                        {{ ((capture.total_pq_buenos/(capture.bpm_actual*60*capture.tiempo))*100)|int }} %
                                    {% else %}
                                        0 %
                                    {% endif %}
                                </td>
                                <td style="background-color: #c8e6c9;">
                                    <input 
                                        type="number" 
                                        class="form-control mejora-propuesta-input" 
                                        value="{{ capture.mejora_propuesta }}" 
                                        data-capture-index="{{ loop.index0 }}"
                                        min="0"
                                    >
                                </td>
                                <td class="eff-propuesta" style="background-color: #bbdefb;">
                                    {% if capture.bpm_actual != 0 %}
                                        {{ (((capture.total_pq_buenos/(capture.bpm_actual*60*capture.tiempo))*100) + capture.mejora_propuesta) |int }} %
                                    {% else %}
                                        0 %
                                    {% endif %}
                                </td>
                                <td class="std-pt" style="background-color: #bbdefb;">{{ ((((capture.peso_gr/1000)*capture.bpm_actual*60)*capture.eff_std_empaque)/100) |int }}</td>
                                <td class="actual-pt" style="background-color: #bbdefb;">
                                    {% if capture.bpm_actual != 0 %}                               
                                        {{ ((((capture.peso_gr/1000)*capture.bpm_actual*60)*((capture.total_pq_buenos/(capture.bpm_actual*60*capture.tiempo))*100))/100) |int }}
                                    {% else %}
                                        0 %
                                    {% endif %}
                                </td>
                                <td class="propuesta-pt" style="background-color: #bbdefb;">
                                    {% if capture.bpm_actual != 0 %}                               
                                        {{ ((((capture.peso_gr/1000)*capture.bpm_propuesta*60)*(((capture.total_pq_buenos/(capture.bpm_actual*60*capture.tiempo))*100) + capture.mejora_propuesta))/100) |int }}
                                    {% else %}
                                        0 %
                                    {% endif %}
                                </td>
                                <td class="global-pt" style="background-color: #bbdefb;">{{ ((((capture.peso_gr/1000)*capture.bpm_global*60)*capture.eff_std_empaque)/100) |int }}</td>
                                <td class="desperdicio" style="background-color: #f8d7da;">{{ capture.total_pq - capture.total_pq_buenos |int }}</td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="21" class="text-center">No hay capturas registradas.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <div class="d-flex justify-content-between mt-4">
            <a href="{{ url_for('eff_empaque') }}" class="btn btn-light btn-action">
                <i class="fas fa-arrow-left me-1"></i> Volver
            </a>
            <button type="submit" class="btn btn-pepsico btn-action">
                <i class="fas fa-save me-1"></i> Guardar Ejercicio
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}

<script>
function calcularFila(tr) {
    // Obtener valores de la fila
    const peso_gr = parseFloat(tr.querySelector('.peso-gr').textContent) || 0;
    const bpm_actual = parseFloat(tr.querySelector('.bpm-actual').textContent) || 0;
    const tiempo = parseFloat(tr.querySelector('.tiempo').textContent) || 0;
    const total_pq_buenos = parseFloat(tr.querySelector('.total-pq-buenos').textContent) || 0;
    const bpm_propuesta = parseFloat(tr.querySelector('.bpm-propuesta').textContent) || 0;
    const bpm_global = parseFloat(tr.querySelector('.bpm-global').textContent) || 0;
    const eff_std_empaque = parseFloat(tr.querySelector('.eff-std-empaque').textContent) || 0;
    const mejora_propuesta = parseFloat(tr.querySelector('.mejora-propuesta-input').value) || 0;

    // Cálculos
    const eff_actual_empaque = bpm_actual && tiempo ? ((total_pq_buenos/(bpm_actual*60*tiempo))*100) : 0;
    const eff_propuesta = eff_actual_empaque + mejora_propuesta;
    const std_pt = (((peso_gr/1000)*bpm_actual*60)*eff_std_empaque)/100;
    const actual_pt = (((peso_gr/1000)*bpm_actual*60)*eff_actual_empaque)/100;
    const propuesta_pt = (((peso_gr/1000)*bpm_propuesta*60)*eff_propuesta)/100;
    const global_pt = (((peso_gr/1000)*bpm_global*60)*eff_std_empaque)/100;

    // Actualizar celdas
    tr.querySelector('.eff-actual-empaque').textContent = Math.round(eff_actual_empaque) + ' %';
    tr.querySelector('.eff-propuesta').textContent = Math.round(eff_propuesta) + ' %';
    tr.querySelector('.std-pt').textContent = Math.round(std_pt);
    tr.querySelector('.actual-pt').textContent = Math.round(actual_pt);
    tr.querySelector('.propuesta-pt').textContent = Math.round(propuesta_pt);
    tr.querySelector('.global-pt').textContent = Math.round(global_pt);
}

document.querySelectorAll('.mejora-propuesta-input').forEach(input => {
    input.addEventListener('input', function() {
        const tr = this.closest('tr');
        calcularFila(tr);

        // Mantener la actualización en backend si lo necesitas
        const index = this.dataset.captureIndex;
        const value = this.value;
        fetch('{{ url_for("update_mejora_propuesta", exercise_id=exercise.id) }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token() if csrf_token else "" }}'
            },
            body: JSON.stringify({
                index: index,
                value: value
            })
        })
        .then(res => res.json())
        .then(data => {
            if (!data.success) {
                alert('Error al actualizar: ' + (data.message || ''));
            }
        })
        .catch(() => alert('Error de red al actualizar'));
    });
});

// Inicializar cálculos al cargar
document.querySelectorAll('tbody tr').forEach(tr => {
    if (tr.querySelector('.mejora-propuesta-input')) {
        calcularFila(tr);
    }
});

// Eliminar captura
function deleteCapture(index) {
    if (!confirm('¿Seguro que deseas eliminar esta captura?')) return;
    fetch('{{ url_for("delete_capture_eff_empaque", exercise_id=exercise.id) }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token() if csrf_token else "" }}'
        },
        body: JSON.stringify({ index: index })
    })
    .then(res => res.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Error al eliminar: ' + (data.message || ''));
        }
    })
    .catch(() => alert('Error de red al eliminar'));
}

// Inicializar DataTable con scroll horizontal
$(document).ready(function() {
    $('#capturesContainer table').DataTable({
        scrollX: true,
        paging: false,
        searching: false,
        info: false,
        ordering: false,
        autoWidth: false
    });
});
</script>
{% endblock %}