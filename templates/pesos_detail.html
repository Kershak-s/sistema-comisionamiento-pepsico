{% extends "base.html" %}
{% block title %}Control de Pesos{% endblock %}
{% block page_title %}Control de Pesos{% endblock %}

{% block extra_styles %}
<style>
    .back-link {
        color: var(--pepsico-blue);
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        font-weight: 500;
        font-size: 0.9rem;
        margin-bottom: 1rem;
        transition: all 0.3s ease;
    }
    
    .back-link:hover {
        color: var(--pepsico-light-blue);
        transform: translateX(-5px);
    }
    
    .back-link i {
        margin-right: 0.25rem;
    }

    /* Enhanced Header - Compact */
    .page-header {
        background: linear-gradient(135deg, var(--pepsico-blue) 0%, var(--pepsico-light-blue) 100%);
        border-radius: 15px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 8px 25px rgba(0, 87, 168, 0.15);
    }

    .page-header h2 {
        color: white;
        margin: 0;
        font-weight: 700;
        text-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }

    .page-header .btn {
        box-shadow: 0 4px 15px rgba(255,255,255,0.2);
        border: none;
        font-weight: 600;
        padding: 0.75rem 1.5rem;
        transition: all 0.3s ease;
    }

    .page-header .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(255,255,255,0.3);
    }

    /* Enhanced Cards - Compact Version */
    .stats-grid {
        margin-bottom: 2rem;
    }

    .stat-card {
        background: linear-gradient(145deg, #ffffff 0%, #f8f9fa 100%);
        border: none;
        border-radius: 12px;
        padding: 1rem;
        height: 100%;
        transition: all 0.3s ease;
        box-shadow: 0 3px 15px rgba(0, 87, 168, 0.08);
        position: relative;
        overflow: hidden;
    }

    .stat-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: linear-gradient(90deg, var(--pepsico-blue), var(--pepsico-light-blue));
        border-radius: 12px 12px 0 0;
    }

    .stat-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 25px rgba(0, 87, 168, 0.15);
    }

    .stat-card .card-icon {
        background: linear-gradient(135deg, var(--pepsico-blue), var(--pepsico-light-blue));
        color: white;
        width: 35px;
        height: 35px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 0.7rem;
        font-size: 1rem;
        box-shadow: 0 3px 10px rgba(0, 87, 168, 0.2);
    }

    .stat-card .card-title {
        color: #495057;
        font-size: 0.75rem;
        font-weight: 600;
        margin-bottom: 0.3rem;
        text-transform: uppercase;
        letter-spacing: 0.3px;
        line-height: 1.1;
    }

    .stat-card .card-value {
        color: var(--pepsico-blue);
        font-size: 1.4rem;
        font-weight: 700;
        margin: 0;
        line-height: 1.1;
    }

    .stat-card .card-unit {
        color: #6c757d;
        font-size: 0.8rem;
        font-weight: 500;
        margin-left: 0.2rem;
    }

    /* Button Enhancements */
    .btn-primary,
    .btn.btn-primary {
        background: linear-gradient(135deg, var(--pepsico-blue) 0%, var(--pepsico-light-blue) 100%) !important;
        border: none !important;
        color: #fff !important;
        font-weight: 600;
        border-radius: 10px;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(0, 87, 168, 0.2);
    }
    .btn-primary:hover,
    .btn.btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(0, 87, 168, 0.3);
    }

    .btn-warning,
    .btn.btn-warning {
        background: linear-gradient(135deg, var(--frito-lay-yellow) 0%, #f8d12f 100%) !important;
        border: none !important;
        color: #333 !important;
        font-weight: 600;
        border-radius: 10px;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(255, 193, 7, 0.2);
    }
    .btn-warning:hover,
    .btn.btn-warning:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(255, 193, 7, 0.3);
    }

    .btn-info,
    .btn.btn-info {
        background: linear-gradient(135deg, #17a2b8 0%, #20c997 100%) !important;
        border: none !important;
        color: #fff !important;
        font-weight: 600;
        border-radius: 10px;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(23, 162, 184, 0.2);
    }
    .btn-info:hover,
    .btn.btn-info:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(23, 162, 184, 0.3);
    }

    .btn-danger,
    .btn.btn-danger {
        background: linear-gradient(135deg, var(--pepsico-red) 0%, #dc3545 100%) !important;
        border: none !important;
        color: #fff !important;
        font-weight: 600;
        border-radius: 10px;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(220, 53, 69, 0.2);
    }
    .btn-danger:hover,
    .btn.btn-danger:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(220, 53, 69, 0.3);
    }

    /* Enhanced Table Container - Compact */
    .pesos-table-container {
        background: linear-gradient(145deg, #ffffff 0%, #f8f9fa 100%);
        border-radius: 20px;
        padding: 0;
        margin-bottom: 1.5rem;
        box-shadow: 0 8px 30px rgba(0, 87, 168, 0.1);
        border: 1px solid rgba(0, 87, 168, 0.1);
        overflow: hidden;
    }

    .pesos-table-title {
        padding: 1.5rem 2rem;
        margin: 0;
        background: linear-gradient(135deg, var(--pepsico-blue) 0%, var(--pepsico-light-blue) 100%);
        color: white;
        font-weight: 700;
        font-size: 1.2rem;
        text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        border-bottom: 3px solid rgba(255,255,255,0.1);
    }

    .pesos-table-responsive {
        border-radius: 0;
        overflow-x: unset !important;
        max-height: unset !important;
        max-height: 70vh;
    }

    .pesos-table {
        margin: 0;
        border-collapse: separate;
        border-spacing: 0;
    }

    .pesos-table thead th {
        font-weight: 700;
        vertical-align: middle;
        background: linear-gradient(135deg, var(--pepsico-blue) 0%, var(--pepsico-light-blue) 100%);
        color: #fff;
        text-align: center;
        padding: 1rem 0.75rem;
        font-size: 0.9rem;
        height: auto;
        border: none;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        text-shadow: 0 1px 2px rgba(0,0,0,0.2);
        position: sticky;
        top: 0;
        z-index: 10;
    }

    .pesos-table tbody td {
        vertical-align: middle;
        padding: 1rem 0.75rem;
        background-color: #fff;
        text-align: center;
        font-size: 0.95rem;
        border-bottom: 1px solid #e9ecef;
        transition: all 0.3s ease;
    }

    .pesos-table tbody tr {
        transition: all 0.3s ease;
    }

    .pesos-table tbody tr:hover {
        background: linear-gradient(90deg, #f8f9fa 0%, #e3f2fd 50%, #f8f9fa 100%);
        transform: scale(1.01);
        box-shadow: 0 4px 15px rgba(0, 87, 168, 0.1);
    }

    .pesos-table .badge {
        font-size: 0.85em;
        padding: 0.5em 1em;
        border-radius: 20px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .pesos-table .btn {
        border-radius: 8px;
        font-size: 0.85em;
        margin: 0 2px;
        transition: all 0.3s ease;
        font-weight: 600;
        width: 35px;
        height: 35px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
    }

    .pesos-table .btn:hover {
        transform: translateY(-2px) scale(1.1);
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }

    /* Modal Enhancements */
    .modal-content {
        border: none;
        border-radius: 20px;
        box-shadow: 0 15px 50px rgba(0,0,0,0.2);
        overflow: hidden;
    }

    .modal-header.bg-primary,
    .modal-header.bg-info,
    .modal-header.bg-warning {
        border: none;
        padding: 1.5rem 2rem;
    }

    .modal-header.bg-primary {
        background: linear-gradient(135deg, var(--pepsico-blue), var(--pepsico-light-blue)) !important;
        color: #fff !important;
    }

    .modal-header.bg-info {
        background: linear-gradient(135deg, #17a2b8, #20c997) !important;
        color: #fff !important;
    }

    .modal-header.bg-warning {
        background: linear-gradient(135deg, var(--frito-lay-yellow), #f8d12f) !important;
        color: #333 !important;
    }

    .modal-title {
        font-weight: 700;
        font-size: 1.3rem;
    }

    .modal-body {
        padding: 2rem;
        background: #f8f9fa;
    }

    .modal-footer {
        padding: 1.5rem 2rem;
        background: #f8f9fa;
        border: none;
    }

    /* Form Enhancements */
    .form-label {
        font-weight: 600;
        color: #495057;
        margin-bottom: 0.5rem;
        text-transform: uppercase;
        font-size: 0.85rem;
        letter-spacing: 0.5px;
    }

    .form-control,
    .form-select {
        border: 2px solid #e9ecef;
        border-radius: 10px;
        padding: 0.75rem 1rem;
        font-size: 0.95rem;
        transition: all 0.3s ease;
        background: #fff;
    }

    .form-control:focus,
    .form-select:focus {
        border-color: var(--pepsico-blue);
        box-shadow: 0 0 0 0.2rem rgba(0, 87, 168, 0.15);
        background: #fff;
    }

    /* Badge Improvements */
    .badge.bg-primary {
        background: linear-gradient(135deg, var(--pepsico-blue), var(--pepsico-light-blue)) !important;
    }
    .badge.bg-success {
        background: linear-gradient(135deg, #28a745, #20c997) !important;
    }
    .badge.bg-danger {
        background: linear-gradient(135deg, var(--pepsico-red), #dc3545) !important;
    }

    /* Inputs en los modales */
    #inputsPesos .card {
        background: #fff;
        border-radius: 12px;
        border: 2px solid #e9ecef;
        box-shadow: 0 4px 15px rgba(0,87,168,0.08);
        transition: all 0.3s ease;
    }

    #inputsPesos .card:hover {
        border-color: var(--pepsico-blue);
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(0,87,168,0.15);
    }

    /* Progress Badge for Pesos */
    #porcentaje_pesos {
        font-size: 1.1em !important;
        padding: 0.6em 1.2em;
        border-radius: 25px;
        background: linear-gradient(135deg, var(--pepsico-blue), var(--pepsico-light-blue)) !important;
        box-shadow: 0 3px 10px rgba(0, 87, 168, 0.3);
        transition: all 0.3s ease;
    }

    /* Responsive improvements */
    @media (max-width: 991px) {
        .pesos-table-container {
            margin: 1rem 0;
        }
        .pesos-table-title {
            padding: 1rem 1.5rem;
            font-size: 1.1rem;
        }
        .page-header {
            padding: 1.5rem;
        }
        .stat-card {
            margin-bottom: 0.8rem;
        }
        .stats-grid {
            margin-bottom: 1.5rem;
        }
    }

    @media (max-width: 768px) {
        .page-header {
            text-align: center;
        }
        .page-header .d-flex {
            flex-direction: column;
            gap: 1rem;
        }
        .stats-grid .col-6 {
            margin-bottom: 0.5rem;
        }
        .stat-card {
            padding: 0.8rem;
        }
        .stat-card .card-icon {
            width: 30px;
            height: 30px;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }
        .stat-card .card-title {
            font-size: 0.7rem;
        }
        .stat-card .card-value {
            font-size: 1.2rem;
        }
    }

    /* Animation for loading states */
    .deleting-row {
        opacity: 0.5;
        transition: opacity 0.3s ease;
    }

    /* Utility classes */
    .text-gradient {
        background: linear-gradient(135deg, var(--pepsico-blue), var(--pepsico-light-blue));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }
</style>
{% endblock %}

{% block content %}
<a href="{{ url_for('pesos') }}" class="back-link">
    <i class="fas fa-arrow-left"></i> Volver a Carga de Pesos
</a>

<main class="container-fluid py-4">
    <!-- Enhanced Header -->
    <div class="page-header">
        <div class="d-flex justify-content-between align-items-center">
            <h2 class="mb-0">
                <i class="fas fa-weight-hanging me-3"></i>
                Control de Pesos
            </h2>
            <button type="button" id="btnNuevaCaptura" class="btn btn-light" data-bs-toggle="modal"
                data-bs-target="#modalNuevaCaptura">
                <i class="fas fa-plus me-2"></i>Nueva Captura
            </button>
        </div>
    </div>

    <!-- Enhanced Statistics Grid - Compact -->
    <div class="stats-grid">
        <div class="row g-3">
            <!-- Peso medio -->
            <div class="col-6 col-lg-3 col-xl-2">
                <div class="card stat-card">
                    <div class="card-icon">
                        <i class="fas fa-weight"></i>
                    </div>
                    <h6 class="card-title">Peso medio</h6>
                    <p class="card-value">
                        {{ datos["Peso medio"] | default(0) | round(2) }}
                        <span class="card-unit">g</span>
                    </p>
                </div>
            </div>
            <!-- Peso mínimo -->
            <div class="col-6 col-lg-3 col-xl-2">
                <div class="card stat-card">
                    <div class="card-icon">
                        <i class="fas fa-balance-scale-left"></i>
                    </div>
                    <h6 class="card-title">Peso mínimo</h6>
                    <p class="card-value">
                        {{ datos["Peso minimo"] | default(0) | round(2) }}
                        <span class="card-unit">g</span>
                    </p>
                </div>
            </div>
            <!-- Peso máximo -->
            <div class="col-6 col-lg-3 col-xl-2">
                <div class="card stat-card">
                    <div class="card-icon">
                        <i class="fas fa-balance-scale-right"></i>
                    </div>
                    <h6 class="card-title">Peso máximo</h6>
                    <p class="card-value">
                        {{ datos["Peso maximo"] | default(0) | round(2) }}
                        <span class="card-unit">g</span>
                    </p>
                </div>
            </div>
            <!-- Desviación estándar -->
            <div class="col-6 col-lg-3 col-xl-2">
                <div class="card stat-card">
                    <div class="card-icon">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <h6 class="card-title">Desviación estándar</h6>
                    <p class="card-value">
                        {{ datos["Desviacion"] | default(0) | round(2) }}
                        <span class="card-unit">g</span>
                    </p>
                </div>
            </div>
            <!-- Sobrepeso -->
            <div class="col-6 col-lg-3 col-xl-2">
                <div class="card stat-card">
                    <div class="card-icon">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <h6 class="card-title">Sobrepeso</h6>
                    <p class="card-value">
                        {{datos["Sobrepeso"] | default(0) | round(2) }}
                        <span class="card-unit">g</span>
                    </p>
                </div>
            </div>
            <!-- Eficiencia CCW -->
            <div class="col-6 col-lg-3 col-xl-2">
                <div class="card stat-card">
                    <div class="card-icon">
                        <i class="fas fa-percentage"></i>
                    </div>
                    <h6 class="card-title">Eficiencia CCW</h6>
                    <p class="card-value">
                        {{datos["Eficiencia CCW" | default(0)]}}
                        <span class="card-unit">%</span>
                    </p>
                </div>
            </div>
            <!-- Paquetes bajo peso -->
            <div class="col-6 col-lg-3 col-xl-2">
                <div class="card stat-card">
                    <div class="card-icon">
                        <i class="fas fa-boxes"></i>
                    </div>
                    <h6 class="card-title">Paquetes bajo peso</h6>
                    <p class="card-value">
                        {{datos["Paquetes bajo peso"] | default(0) }}
                        <span class="card-unit">uds</span>
                    </p>
                </div>
            </div>
            <!-- Cp -->
            <div class="col-6 col-lg-3 col-xl-2">
                <div class="card stat-card">
                    <div class="card-icon">
                        <i class="fas fa-ruler-combined"></i>
                    </div>
                    <h6 class="card-title">Cp</h6>
                    <p class="card-value">
                        {{datos["Cp"] | default(0) | round(2)}}
                    </p>
                </div>
            </div>
            <!-- Cpk -->
            <div class="col-6 col-lg-3 col-xl-2">
                <div class="card stat-card">
                    <div class="card-icon">
                        <i class="fas fa-ruler"></i>
                    </div>
                    <h6 class="card-title">Cpk</h6>
                    <p class="card-value">
                        {{datos["Cpk"] | default(0) | round(2)}}
                    </p>
                </div>
            </div>
            <!-- Pp -->
            <div class="col-6 col-lg-3 col-xl-2">
                <div class="card stat-card">
                    <div class="card-icon">
                        <i class="fas fa-ruler-horizontal"></i>
                    </div>
                    <h6 class="card-title">Pp</h6>
                    <p class="card-value">
                        {{datos["Pp"] | default(0) | round(2)}}
                    </p>
                </div>
            </div>
            <!-- Ppk -->
            <div class="col-6 col-lg-3 col-xl-2">
                <div class="card stat-card">
                    <div class="card-icon">
                        <i class="fas fa-ruler-vertical"></i>
                    </div>
                    <h6 class="card-title">Ppk</h6>
                    <p class="card-value">
                        {{datos["Ppk"] | default(0) | round(2) }}
                    </p>
                </div>
            </div>
            <!-- Kilos de sobrepeso -->
            <div class="col-6 col-lg-3 col-xl-2">
                <div class="card stat-card">
                    <div class="card-icon">
                        <i class="fas fa-weight-hanging"></i>
                    </div>
                    <h6 class="card-title">Kilos de sobrepeso</h6>
                    <p class="card-value">
                        {{datos["Kilos de sobrepeso"] | default(0) }}
                        <span class="card-unit">kg</span>
                    </p>
                </div>
            </div>
            <!-- Proyección de sobrepeso -->
            <div class="col-6 col-lg-3 col-xl-2">
                <div class="card stat-card">
                    <div class="card-icon">
                        <i class="fas fa-chart-bar"></i>
                    </div>
                    <h6 class="card-title">Proyección anual</h6>
                    <p class="card-value">
                        {{datos["Proyeccion de sobrepeso"] | default(0) | round(2) }}
                        <span class="card-unit">Kg</span>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Formulario Modal para Captura de Datos -->
    <div class="modal fade" id="modalNuevaCaptura" tabindex="-1" aria-labelledby="nuevaCapturaLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="nuevaCapturaLabel"><i class="fas fa-plus-circle me-2"></i>Nueva Captura
                        de
                        Pesos</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        aria-label="Close"></button>
                </div>
                <form id="formNuevaCaptura" method="POST" action="{{ url_for('pesos_detail', id=ejercicio.id) }}">
                    <div class="modal-body">
                        <div class="row">
                            <input type="hidden" name="fecha" value="{{ now.strftime('%Y-%m-%d') }}">
                            <input type="hidden" name="user_id" value="{{ session.get('user_id', '') }}">
                            <div class="col-md-4 mb-3">
                                <label for="turno" class="form-label">Turno</label>
                                <select class="form-select" id="turno" name="turno" required>
                                    <option value="">Seleccione turno</option>
                                    <option value="1">1</option>
                                    <option value="2">2</option>
                                    <option value="3">3</option>
                                </select>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="producto_id" class="form-label">Producto</label>
                                <select class="form-select" id="producto_id" name="producto_id" required>
                                    {% for producto in productos %}
                                        <option value="{{ producto.id }}">{{ producto.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="maquina_id" class="form-label">Máquina</label>
                                <select class="form-select" id="maquina_id" name="maquina_id" required>
                                    <option value="">Seleccione máquina</option>
                                    {% for i in range(1, 16) %}
                                        <option value="Maquina {{ i }}">Maquina {{ i }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="peso_fijado" class="form-label">Peso Fijado</label>
                                <input type="number" class="form-control" id="peso_fijado" name="peso_fijado" required>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="limite_superior" class="form-label">Límite Superior</label>
                                <input type="number" class="form-control" id="limite_superior" name="limite_superior"
                                    required>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="control_promedio" class="form-label">Control Promedio</label>
                                <select class="form-select" id="control_promedio" name="control_promedio" required>
                                    <option value="">Seleccione</option>
                                    <option value="ON">ON</option>
                                    <option value="OFF">OFF</option>
                                </select>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="compensacion" class="form-label">Compensación</label>
                                <input type="number" step="0.01" class="form-control" id="compensacion"
                                    name="compensacion" required>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="intervalo_auto_cero" class="form-label">Intervalo Auto Cero</label>
                                <input type="number" class="form-control" id="intervalo_auto_cero"
                                    name="intervalo_auto_cero" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="numero_estable" class="form-label">Número Estable</label>
                                <input type="number" class="form-control" id="numero_estable" name="numero_estable"
                                    required>
                            </div>
                        </div>
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Guardar Captura</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal para editar registro de peso -->
    <div class="modal fade" id="modalEditarRegistro" tabindex="-1" aria-labelledby="editarRegistroLabel" aria-hidden="true">
      <div class="modal-dialog modal-xl">
        <div class="modal-content">
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title" id="editarRegistroLabel"><i class="fas fa-edit me-2"></i>Editar Registro de Peso</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
          </div>
          <form id="formEditarRegistro">
            <div class="modal-body">
              <input type="hidden" id="edit_id" name="id">
              <div class="row">
                <div class="col-md-4 mb-3">
                  <label for="edit_turno" class="form-label">Turno</label>
                  <select class="form-select" id="edit_turno" name="turno" required>
                    <option value="">Seleccione turno</option>
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                  </select>
                </div>
                <div class="col-md-4 mb-3">
                  <label for="edit_producto_id" class="form-label">Producto</label>
                  <select class="form-select" id="edit_producto_id" name="producto_id" required>
                    {% for producto in productos %}
                      <option value="{{ producto.id }}">{{ producto.name }}</option>
                    {% endfor %}
                  </select>
                </div>
                <div class="col-md-4 mb-3">
                  <label for="edit_maquina_id" class="form-label">Máquina</label>
                  <select class="form-select" id="edit_maquina_id" name="maquina_id" required>
                    <option value="">Seleccione máquina</option>
                    {% for i in range(1, 16) %}
                      <option value="Maquina {{ i }}">Maquina {{ i }}</option>
                    {% endfor %}
                  </select>
                </div>
              </div>
              <div class="row">
                <div class="col-md-4 mb-3">
                  <label for="edit_peso_fijado" class="form-label">Peso Fijado</label>
                  <input type="number" class="form-control" id="edit_peso_fijado" name="peso_fijado" required>
                </div>
                <div class="col-md-4 mb-3">
                  <label for="edit_limite_superior" class="form-label">Límite Superior</label>
                  <input type="number" class="form-control" id="edit_limite_superior" name="limite_superior" required>
                </div>
                <div class="col-md-4 mb-3">
                  <label for="edit_control_promedio" class="form-label">Control Promedio</label>
                  <select class="form-select" id="edit_control_promedio" name="control_promedio" required>
                    <option value="">Seleccione</option>
                    <option value="ON">ON</option>
                    <option value="OFF">OFF</option>
                  </select>
                </div>
              </div>
              <div class="row">
                <div class="col-md-4 mb-3">
                  <label for="edit_compensacion" class="form-label">Compensación</label>
                  <input type="number" step="0.01" class="form-control" id="edit_compensacion" name="compensacion" required>
                </div>
                <div class="col-md-4 mb-3">
                  <label for="edit_intervalo_auto_cero" class="form-label">Intervalo Auto Cero</label>
                  <input type="number" class="form-control" id="edit_intervalo_auto_cero" name="intervalo_auto_cero" required>
                </div>
                <div class="col-md-4 mb-3">
                  <label for="edit_numero_estable" class="form-label">Número Estable</label>
                  <input type="number" class="form-control" id="edit_numero_estable" name="numero_estable" required>
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
              <button type="submit" class="btn btn-primary">Guardar Cambios</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Modal para ver/editar pesos individuales -->
    <div class="modal fade" id="modalVerPesos" tabindex="-1" aria-labelledby="verPesosLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <form id="formPesosIndividuales">
            <div class="modal-header bg-info text-white">
              <h5 class="modal-title" id="verPesosLabel"><i class="fas fa-balance-scale me-2"></i> Pesos Individuales</h5>
              <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body">
              <input type="hidden" id="pesos_registro_id" name="registro_id">
              <input type="hidden" id="pesos_captura_idx" name="captura_idx">
              <div class="mb-4 d-flex align-items-center justify-content-between">
                <div class="d-flex align-items-center">
                  <label for="cantidad_pesos" class="form-label mb-0 me-3">Cantidad de Pesos</label>
                  <input type="number" min="1" class="form-control me-3" style="max-width:120px;" id="cantidad_pesos" name="cantidad_pesos" required>
                </div>
                <span id="porcentaje_pesos" class="badge bg-primary">0%</span>
              </div>
              <div id="inputsPesos"></div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
              <button type="submit" class="btn btn-info">Guardar Pesos</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Enhanced Table -->
    <div class="pesos-table-container">
        <div class="pesos-table-title">
            <i class="fas fa-database me-2"></i> Registros de Pesos
        </div>
        <div class="pesos-table-responsive">
            <table class="table table-hover pesos-table" id="pesosDatatable">
                <thead>
                    <tr>
                        <th>Máquina</th>
                        <th>Producto</th>
                        <th>Turno</th>
                        <th>Operador</th>
                        <th>Peso Fijado</th>
                        <th>Límite Superior</th>
                        <th>Control Promedio</th>
                        <th>Compensación</th>
                        <th>Intervalo Auto Cero</th>
                        <th>Número Estable</th>
                        <th>Pesos</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for r in registros %}
                      {% set data = r.data | fromjson %}
                      {% for captura in data.Capturas %}
                        <tr>
                          <td><strong>{{ captura.maquina or '' }}</strong></td>
                          <td>
                            {% set sabor_id = captura.sabor_id if 'sabor_id' in captura else None %}
                            {% if sabor_id %}
                              {% for producto in productos %}
                                {% if producto.id == sabor_id|int %}{{ producto.name }}{% endif %}
                              {% endfor %}
                            {% endif %}
                          </td>
                          <td><span class="badge bg-primary">{{ captura.turno or '' }}</span></td>
                          <td>{{ captura.usuario or r.usuario or '' }}</td>
                          <td><strong>{{ captura.peso_fijado or '' }}</strong></td>
                          <td>{{ captura.limite_superior or '' }}</td>
                          <td>
                            {% if captura.control_promedio == 'ON' %}
                              <span class="badge bg-success">ON</span>
                            {% elif captura.control_promedio == 'OFF' %}
                              <span class="badge bg-danger">OFF</span>
                            {% else %}
                              {{ captura.control_promedio or '' }}
                            {% endif %}
                          </td>
                          <td>{{ captura.compensacion or '' }}</td>
                          <td>{{ captura.intervalo_auto_cero or '' }}</td>
                          <td>{{ captura.numero_estable or '' }}</td>
                          <td>
                            <button class="btn btn-sm btn-info ver-pesos" data-id="{{ r.id }}" data-captura-idx="{{ loop.index0 }}" title="Ver Pesos">
                                <i class="fas fa-balance-scale"></i>
                            </button>
                          </td>
                          <td>
                            <div class="d-flex justify-content-center gap-1">
                              <button class="btn btn-sm btn-warning editar-registro"
                                data-id="{{ r.id }}"
                                data-captura-idx="{{ loop.index0 }}"
                                title="Editar">
                                <i class="fas fa-edit"></i>
                              </button>
                              <button class="btn btn-sm btn-danger eliminar-captura"
                                data-id="{{ r.id }}"
                                data-captura-idx="{{ loop.index0 }}"
                                title="Eliminar">
                                <i class="fas fa-trash"></i>
                              </button>
                            </div>
                          </td>
                        </tr>
                      {% endfor %}
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</main>
{% endblock %}

{% block extra_scripts %}
<script>
// Inicializar DataTable with scroll horizontal, without pagination, search, or order
$(document).ready(function() {
    $('#pesosDatatable').DataTable({
        scrollX: true,
        paging: false,
        searching: false,
        info: false,
        ordering: false,
        autoWidth: false,
        language: {
            url: '//cdn.datatables.net/plug-ins/1.10.24/i18n/Spanish.json'
        }
    });
});

// Eliminar registro
$(document).on('click', '.eliminar-registro', function () {
    const id = $(this).data('id');
    const $row = $(this).closest('tr');
    if (confirm('¿Está seguro que desea eliminar este registro? Esta acción no puede deshacerse.')) {
        $row.addClass('deleting-row');
        $.ajax({
            url: '/vaciar_registro_peso/' + id,
            method: 'POST',
            success: function (response) {
                if (response.success) {
                    location.reload();
                } else {
                    alert('Error al vaciar: ' + response.message);
                    $row.removeClass('deleting-row');
                }
            },
            error: function (error) {
                console.error('Error en la operación de vaciado', error);
                alert('Ha ocurrido un error al intentar vaciar el registro.');
                $row.removeClass('deleting-row');
            }
        });
    }
});

// Abrir modal de edición y cargar datos
$(document).on('click', '.editar-registro', function () {
    const id = $(this).data('id');
    const captura_idx = $(this).data('captura-idx'); // <-- Tomar el índice
    // Pasar el índice como parámetro GET
    $.get('/editar_registro_peso/' + id + '?captura_idx=' + captura_idx, function (data) {
        $('#edit_id').val(data.id);
        $('#edit_turno').val(data.turno);
        $('#edit_producto_id').val(data.producto_id);
        $('#edit_maquina_id').val(data.maquina_id);
        $('#edit_peso_fijado').val(data.peso_fijado);
        $('#edit_limite_superior').val(data.limite_superior);
        $('#edit_control_promedio').val(data.control_promedio);
        $('#edit_compensacion').val(data.compensacion);
        $('#edit_intervalo_auto_cero').val(data.intervalo_auto_cero);
        $('#edit_numero_estable').val(data.numero_estable);
        // Guardar el índice en el formulario (en memoria)
        $('#formEditarRegistro').data('captura-idx', captura_idx);
        $('#modalEditarRegistro').modal('show');
    });
});

// Guardar cambios del registro editado
$('#formEditarRegistro').on('submit', function (e) {
    e.preventDefault();
    const id = $('#edit_id').val();
    const captura_idx = $(this).data('captura-idx'); // <-- Tomar el índice guardado
    const payload = {
        captura_idx: captura_idx, // <-- Enviar el índice al backend
        turno: $('#edit_turno').val(),
        producto_id: $('#edit_producto_id').val(),
        maquina_id: $('#edit_maquina_id').val(),
        peso_fijado: $('#edit_peso_fijado').val(),
        limite_superior: $('#edit_limite_superior').val(),
        control_promedio: $('#edit_control_promedio').val(),
        compensacion: $('#edit_compensacion').val(),
        intervalo_auto_cero: $('#edit_intervalo_auto_cero').val(),
        numero_estable: $('#edit_numero_estable').val()
    };
    $.ajax({
        url: '/editar_registro_peso/' + id,
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(payload),
        success: function (response) {
            if (response.success) {
                $('#modalEditarRegistro').modal('hide');
                location.reload();
            } else {
                alert('Error al guardar cambios: ' + (response.message || ''));
            }
        },
        error: function () {
            alert('Error al guardar cambios');
        }
    });
});

// Abrir modal de pesos individuales y cargar datos
$(document).on('click', '.ver-pesos', function () {
    const id = $(this).data('id');
    const captura_idx = $(this).data('captura-idx');
    $('#pesos_registro_id').val(id);
    $('#pesos_captura_idx').val(captura_idx); // Nuevo input oculto
    // Obtener los datos actuales
    $.get('/obtener_pesos_individuales/' + id + '?captura_idx=' + captura_idx, function (data) {
        $('#cantidad_pesos').val(data.cantidad || 1);
        renderInputsPesos(data.cantidad || 1, data.pesos || []);
        $('#modalVerPesos').modal('show');
    });
});

// Actualiza el porcentaje de campos llenados
function actualizarPorcentajePesos() {
    const total = parseInt($('#cantidad_pesos').val()) || 1;
    let llenos = 0;
    $('.peso-individual').each(function () {
        if ($(this).val() !== '' && !isNaN($(this).val())) {
            llenos++;
        }
    });
    const porcentaje = Math.round((llenos / total) * 100);
    $('#porcentaje_pesos').text(porcentaje + '%');
}

// Renderizar los inputs de pesos según la cantidad, usando SOLO los valores recibidos
function renderInputsPesos(cantidad, valores) {
    let html = '<div class="row g-3">';
    for (let i = 0; i < cantidad; i++) {
        let valor = valores[i] !== undefined ? valores[i] : '';
        html += `
            <div class="col-6 col-md-4">
                <div class="card p-3 shadow-sm">
                    <label class="form-label mb-2">Peso ${i + 1}:</label>
                    <input type="number" step="0.01" class="form-control peso-individual" name="peso_${i}" value="${valor}">
                </div>
            </div>
        `;
    }
    html += '</div>';
    $('#inputsPesos').html(html);
    actualizarPorcentajePesos();
    // Escuchar cambios en los nuevos inputs
    $('.peso-individual').on('input', actualizarPorcentajePesos);
}

// Cuando cambias la cantidad manualmente, puedes seguir usando los valores actuales en pantalla
$('#cantidad_pesos').on('input', function () {
    const cantidad = parseInt($(this).val()) || 1;
    // Toma los valores actuales de los inputs en pantalla
    let actuales = [];
    $('.peso-individual').each(function () {
        actuales.push($(this).val());
    });
    renderInputsPesos(cantidad, actuales);
});

// Cambiar la cantidad de inputs al modificar el número, conservando los valores digitados
$('#cantidad_pesos').on('input', function () {
    const cantidad = parseInt($(this).val()) || 1;
    // Toma los valores actuales de los inputs en pantalla
    let actuales = [];
    $('.peso-individual').each(function () {
        actuales.push($(this).val());
    });
    renderInputsPesos(cantidad, actuales);
});

// Actualizar porcentaje al abrir el modal y al cambiar los valores
$(document).on('shown.bs.modal', '#modalVerPesos', function () {
    actualizarPorcentajePesos();
    $('.peso-individual').on('input', actualizarPorcentajePesos);
});

// Guardar los pesos individuales
$('#formPesosIndividuales').on('submit', function (e) {
    e.preventDefault();
    const id = $('#pesos_registro_id').val();
    const captura_idx = $('#pesos_captura_idx').val();
    const cantidad = parseInt($('#cantidad_pesos').val()) || 1;
    let pesos = [];
    $('.peso-individual').each(function () {
        pesos.push(parseFloat($(this).val()) || 0);
    });
    $.ajax({
        url: '/guardar_pesos_individuales/' + id,
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({ cantidad: cantidad, pesos: pesos, captura_idx: captura_idx }),
        success: function (resp) {
            if (resp.success) {
                $('#modalVerPesos').modal('hide');
                location.reload();
            } else {
                alert('Error al guardar: ' + (resp.message || ''));
            }
        },
        error: function () {
            alert('Error al guardar los pesos');
        }
    });
});

// Eliminar captura
$(document).on('click', '.eliminar-captura', function () {
    const id = $(this).data('id');
    const captura_idx = $(this).data('captura-idx');
    const $row = $(this).closest('tr');
    if (confirm('¿Está seguro que desea eliminar esta captura? Esta acción no puede deshacerse.')) {
        $row.addClass('deleting-row');
        $.ajax({
            url: '/eliminar_captura_peso/' + id,
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ captura_idx: captura_idx }),
            success: function (response) {
                if (response.success) {
                    location.reload();
                } else {
                    alert('Error al eliminar: ' + response.message);
                    $row.removeClass('deleting-row');
                }
            },
            error: function (error) {
                console.error('Error en la operación de eliminación', error);
                alert('Ha ocurrido un error al intentar eliminar la captura.');
                $row.removeClass('deleting-row');
            }
        });
    }
});
</script>
{% endblock %}