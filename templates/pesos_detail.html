{% extends "base.html" %}
{% block title %}Control de Pesos{% endblock %}
{% block page_title %}Control de Pesos{% endblock %}

{% block extra_styles %}
<style>
    .back-link {
        color: var(--pepsico-blue);
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        font-weight: 500;
        font-size: 0.9rem;
        margin-bottom: 1rem;
    }
    
    .back-link i {
        margin-right: 0.25rem;
    }

    .card{
        background-color: var(--pepsico-blue);
    }

    .btn-primary,
    .btn.btn-primary {
        background-color: var(--pepsico-blue) !important;
        border-color: var(--pepsico-blue) !important;
        color: #fff !important;
    }
    .btn-primary:hover,
    .btn.btn-primary:hover {
        background-color: var(--pepsico-light-blue) !important;
        border-color: var(--pepsico-light-blue) !important;
    }

    .btn-warning,
    .btn.btn-warning {
        background-color: var(--frito-lay-yellow) !important;
        border-color: var(--frito-lay-yellow) !important;
        color: #333 !important;
    }
    .btn-warning:hover,
    .btn.btn-warning:hover {
        background-color: #e6bb00 !important;
        border-color: #e6bb00 !important;
        color: #222 !important;
    }

    .btn-info,
    .btn.btn-info {
        background-color: var(--pepsico-blue) !important;
        border-color: var(--pepsico-blue) !important;
        color: #fff !important;
    }
    .btn-info:hover,
    .btn.btn-info:hover {
        background-color: var(--pepsico-light-blue) !important;
        border-color: var(--pepsico-light-blue) !important;
    }

    .btn-danger,
    .btn.btn-danger {
        background-color: var(--pepsico-red) !important;
        border-color: var(--pepsico-red) !important;
        color: #fff !important;
    }
    .btn-danger:hover,
    .btn.btn-danger:hover {
        background-color: #b80029 !important;
        border-color: #b80029 !important;
    }

    .pesos-table-container {
        background-color: white;
        border-radius: 12px;
        padding: 2rem 1.5rem 1.5rem 1.5rem;
        margin-bottom: 2rem;
        box-shadow: 0 4px 12px rgba(0, 87, 168, 0.08);
    }
    .pesos-table-title {
        padding: 1rem 1.5rem;
        margin: 0;
        background-color:  var(--pepsico-blue);
        color: white;
        font-weight: 600;
        font-size: 1.1rem;
        border-radius: 10px 10px 0 0;
        text-shadow: 0 1px 2px rgba(0,0,0,0.2);
    }
    .pesos-table-responsive {
        border-radius: 10px;
        overflow: hidden;
    }
    .pesos-table thead th {
        font-weight: 600;
        vertical-align: middle;
        background-color: var(--pepsico-blue);
        color: #fff;
        text-align: center;
        padding: 0.75rem 0.5rem;
        font-size: 0.95rem;
        height: 50px;
        border-bottom: 2px solid #dee2e6;
    }
    .pesos-table tbody td {
        vertical-align: middle;
        padding: 0.5rem;
        height: 48px;
        background-color: #fff;
        text-align: center;
        font-size: 0.97rem;
    }
    .pesos-table tbody tr:hover {
        background-color: #f5faff;
    }
    .pesos-table .badge {
        font-size: 0.95em;
        padding: 0.5em 0.8em;
        border-radius: 6px;
        font-weight: 500;
    }
    .pesos-table .btn {
        border-radius: 6px;
        font-size: 0.95em;
        margin: 0 2px;
        transition: all 0.2s;
    }
    .pesos-table .btn-info {
        color: #fff;
        border: none;
    }
    .pesos-table .btn-warning {
        color: #333;
        border: none;
    }
    .pesos-table .btn-danger {
        color: #fff;
        border: none;
    }
    .pesos-table .btn-success {
        color: #fff;
        border: none;
    }
    .pesos-table .btn:hover {
        filter: brightness(0.95);
        box-shadow: 0 2px 8px rgba(0,87,168,0.08);
        transform: translateY(-1px);
    }
    @media (max-width: 991px) {
        .pesos-table-container {
            padding: 1rem 0.5rem;
        }
        .pesos-table-title {
            padding: 0.7rem 1rem;
            font-size: 1rem;
        }
    }

    /* Modales con cabecera personalizada */
    .modal-header.bg-primary,
    .modal-header.bg-info,
    .modal-header.bg-warning {
        border-top-left-radius: 0.5rem;
        border-top-right-radius: 0.5rem;
        border-bottom: none;
    }
    .modal-header.bg-primary {
        background-color: var(--pepsico-blue) !important;
        color: #fff !important;
    }
    .modal-header.bg-info {
        background-color: var(--pepsico-light-blue) !important;
        color: #fff !important;
    }
    .modal-header.bg-warning {
        background-color: var(--frito-lay-yellow) !important;
        color: #333 !important;
    }

    /* Mejorar el aspecto de los badges */
    .badge.bg-primary {
        background-color: var(--pepsico-blue) !important;
    }
    .badge.bg-success {
        background-color: #28a745 !important;
    }
    .badge.bg-danger {
        background-color: var(--pepsico-red) !important;
    }

    /* Inputs en los modales */
    #inputsPesos .card {
        background: #f8f9fa;
        border-radius: 8px;
        border: 1px solid #e3e6ea;
        box-shadow: 0 2px 8px rgba(0,87,168,0.05);
    }
</style>
{% endblock %}

{% block content %}
<a href="{{ url_for('pesos') }}" class="back-link">
    <i class="fas fa-arrow-left"></i> Volver a Carga de Pesos
</a>

<main class="container-fluid py-4">
    <!-- Titulo y Boton de nueva captura -->
    <div class="row mb-4">
        <div class="col-12 d-flex justify-content-between align-items-center">
            <h2 class="mb-0"><i class="fas fa-weight-hanging option-icon text-black"></i> Carga de Pesos</h2>
            <button type="button" id="btnNuevaCaptura" class="btn btn-primary" data-bs-toggle="modal"
                data-bs-target="#modalNuevaCaptura">
                <i class="fas fa-plus me-2"></i>Nueva Captura
            </button>
        </div>
    </div> 

    <!-- Datos Pesadora -->
    <div class="container mt-4">
        <div class="row">
            <!-- Card -->
            <div class="col-sm-6 col-md-4 col-lg-3 mb-3">
                <div class="card shadow-sm border-0 text-white p-2" id="cardPesadora">
                    <div class="card-body text-center p-2">
                        <i class="fas fa-weight fa-lg mb-1"></i>
                        <h6 class="card-title text-white mb-1">Peso medio</h6>
                        <p class="card-text fs-6 fw-bold mb-0">{{ datos["Peso medio"] | default(0) | round(2) }} g</p>
                    </div>
                </div>
            </div>
            <!-- Card -->
            <div class="col-sm-6 col-md-4 col-lg-3 mb-3">
                <div class="card shadow-sm border-0 text-white p-2" id="cardPesadora">
                    <div class="card-body text-center p-2">
                        <i class="fas fa-balance-scale-left fa-lg mb-1"></i>
                        <h6 class="card-title text-white mb-1">Peso mínimo</h6>
                        <p class="card-text fs-6 fw-bold mb-0">{{ datos["Peso minimo"] | default(0) | round(2) }} g</p>
                    </div>
                </div>
            </div>
            <!-- Card -->
            <div class="col-sm-6 col-md-4 col-lg-3 mb-3">
                <div class="card shadow-sm border-0 text-white p-2" id="cardPesadora">
                    <div class="card-body text-center p-2">
                        <i class="fas fa-balance-scale-right fa-lg mb-1"></i>
                        <h6 class="card-title text-white mb-1">Peso máximo</h6>
                        <p class="card-text fs-6 fw-bold mb-0">{{ datos["Peso maximo"] | default(0) | round(2) }} g</p>
                    </div>
                </div>
            </div>
            <!-- Card -->
            <div class="col-sm-6 col-md-4 col-lg-3 mb-3">
                <div class="card shadow-sm border-0 text-white p-2" id="cardPesadora">
                    <div class="card-body text-center p-2">
                        <i class="fas fa-chart-line fa-lg mb-1"></i>
                        <h6 class="card-title text-white mb-1">Desviación estándar</h6>
                        <p class="card-text fs-6 fw-bold mb-0">{{ datos["Desviacion"] | default(0) | round(2) }} g</p>
                    </div>
                </div>
            </div>
            <!-- Card -->
            <div class="col-sm-6 col-md-4 col-lg-3 mb-3">
                <div class="card shadow-sm border-0 text-white p-2" id="cardPesadora">
                    <div class="card-body text-center p-2">
                        <i class="fas fa-exclamation-circle fa-lg mb-1"></i>
                        <h6 class="card-title text-white mb-1">Sobrepeso</h6>
                        <p class="card-text fs-6 fw-bold mb-0">{{datos["Sobrepeso"] | default(0) | round(2) }} g</p>
                    </div>
                </div>
            </div>
            <!-- Card -->
            <div class="col-sm-6 col-md-4 col-lg-3 mb-3">
                <div class="card shadow-sm border-0 text-white p-2" id="cardPesadora">
                    <div class="card-body text-center p-2">
                        <i class="fas fa-percent fa-lg mb-1"></i>
                        <h6 class="card-title text-white mb-1">Eficiencia CCW</h6>
                        <p class="card-text fs-6 fw-bold mb-0">{{datos["Eficiencia CCW" | default(0)]}} %</p>
                    </div>
                </div>
            </div>
            <!-- Card -->
            <div class="col-sm-6 col-md-4 col-lg-3 mb-3">
                <div class="card shadow-sm border-0 text-white p-2" id="cardPesadora">
                    <div class="card-body text-center p-2">
                        <i class="fas fa-boxes fa-lg mb-1"></i>
                        <h6 class="card-title text-white mb-1"># Paquetes con bajo peso</h6>
                        <p class="card-text fs-6 fw-bold mb-0">{{datos["Paquetes bajo peso"] | default(0) }}</p>
                    </div>
                </div>
            </div>
            <!-- Card -->
            <div class="col-sm-6 col-md-4 col-lg-3 mb-3">
                <div class="card shadow-sm border-0 text-white p-2" id="cardPesadora">
                    <div class="card-body text-center p-2">
                        <i class="fas fa-ruler-combined fa-lg mb-1"></i>
                        <h6 class="card-title text-white mb-1">Cp</h6>
                        <p class="card-text fs-6 fw-bold mb-0">{{datos["Cp"] | default(0) | round(2)}}</p>
                    </div>
                </div>
            </div>
            <!-- Card -->
            <div class="col-sm-6 col-md-4 col-lg-3 mb-3">
                <div class="card shadow-sm border-0 text-white p-2" id="cardPesadora">
                    <div class="card-body text-center p-2">
                        <i class="fas fa-ruler fa-lg mb-1"></i>
                        <h6 class="card-title text-white mb-1">Cpk</h6>
                        <p class="card-text fs-6 fw-bold mb-0">{{datos["Cpk"] | default(0) | round(2)}}</p>
                    </div>
                </div>
            </div>
            <!-- Card -->
            <div class="col-sm-6 col-md-4 col-lg-3 mb-3">
                <div class="card shadow-sm border-0 text-white p-2" id="cardPesadora">
                    <div class="card-body text-center p-2">
                        <i class="fas fa-ruler-horizontal fa-lg mb-1"></i>
                        <h6 class="card-title text-white mb-1">Pp</h6>
                        <p class="card-text fs-6 fw-bold mb-0">{{datos["Pp"] | default(0) | round(2)}}</p>
                    </div>
                </div>
            </div>
            <!-- Card -->
            <div class="col-sm-6 col-md-4 col-lg-3 mb-3">
                <div class="card shadow-sm border-0 text-white p-2" id="cardPesadora">
                    <div class="card-body text-center p-2">
                        <i class="fas fa-ruler-vertical fa-lg mb-1"></i>
                        <h6 class="card-title text-white mb-1">Ppk</h6>
                        <p class="card-text fs-6 fw-bold mb-0">{{datos["Ppk"] | default(0) | round(2) }}</p>
                    </div>
                </div>
            </div>
            <!-- Card -->
            <div class="col-sm-6 col-md-4 col-lg-3 mb-3">
                <div class="card shadow-sm border-0 text-white p-2" id="cardPesadora">
                    <div class="card-body text-center p-2">
                        <i class="fas fa-weight-hanging fa-lg mb-1"></i>
                        <h6 class="card-title text-white mb-1">Kilos de sobrepeso</h6>
                        <p class="card-text fs-6 fw-bold mb-0">{{datos["Kilos de sobrepeso"] | default(0) }} kg</p>
                    </div>
                </div>
            </div>
            <!-- Card -->
            <div class="col-sm-6 col-md-4 col-lg-3 mb-3">
                <div class="card shadow-sm border-0 text-white p-2" id="cardPesadora">
                    <div class="card-body text-center p-2">
                        <i class="fas fa-chart-bar fa-lg mb-1"></i>
                        <h6 class="card-title text-white mb-1">Proyección de sobrepeso en 1 año</h6>
                        <p class="card-text fs-6 fw-bold mb-0">{{datos["Proyeccion de sobrepeso"] | default(0) | round(2) }} Kg</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Formulario Modal para Captura de Datos -->
    <div class="modal fade" id="modalNuevaCaptura" tabindex="-1" aria-labelledby="nuevaCapturaLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="nuevaCapturaLabel"><i class="fas fa-plus-circle me-2"></i>Nueva Captura
                        de
                        Pesos</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        aria-label="Close"></button>
                </div>
                <form id="formNuevaCaptura" method="POST" action="{{ url_for('pesos_detail', id=ejercicio.id) }}">
                    <div class="modal-body">
                        <div class="row">
                            <input type="hidden" name="fecha" value="{{ now.strftime('%Y-%m-%d') }}">
                            <input type="hidden" name="user_id" value="{{ session.get('user_id', '') }}">
                            <div class="col-md-4 mb-3">
                                <label for="turno" class="form-label">Turno</label>
                                <select class="form-select" id="turno" name="turno" required>
                                    <option value="">Seleccione turno</option>
                                    <option value="1">1</option>
                                    <option value="2">2</option>
                                    <option value="3">3</option>
                                </select>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="producto_id" class="form-label">Producto</label>
                                <select class="form-select" id="producto_id" name="producto_id" required>
                                    {% for producto in productos %}
                                        <option value="{{ producto.id }}">{{ producto.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="maquina_id" class="form-label">Máquina</label>
                                <select class="form-select" id="maquina_id" name="maquina_id" required>
                                    <option value="">Seleccione máquina</option>
                                    {% for i in range(1, 16) %}
                                        <option value="Maquina {{ i }}">Maquina {{ i }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="peso_fijado" class="form-label">Peso Fijado</label>
                                <input type="number" class="form-control" id="peso_fijado" name="peso_fijado" required>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="limite_superior" class="form-label">Límite Superior</label>
                                <input type="number" class="form-control" id="limite_superior" name="limite_superior"
                                    required>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="control_promedio" class="form-label">Control Promedio</label>
                                <select class="form-select" id="control_promedio" name="control_promedio" required>
                                    <option value="">Seleccione</option>
                                    <option value="ON">ON</option>
                                    <option value="OFF">OFF</option>
                                </select>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="compensacion" class="form-label">Compensación</label>
                                <input type="number" step="0.01" class="form-control" id="compensacion"
                                    name="compensacion" required>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="intervalo_auto_cero" class="form-label">Intervalo Auto Cero</label>
                                <input type="number" class="form-control" id="intervalo_auto_cero"
                                    name="intervalo_auto_cero" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="numero_estable" class="form-label">Número Estable</label>
                                <input type="number" class="form-control" id="numero_estable" name="numero_estable"
                                    required>
                            </div>
                        </div>
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Guardar Captura</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal para editar registro de peso -->
    <div class="modal fade" id="modalEditarRegistro" tabindex="-1" aria-labelledby="editarRegistroLabel" aria-hidden="true">
      <div class="modal-dialog modal-xl">
        <div class="modal-content">
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title" id="editarRegistroLabel"><i class="fas fa-edit me-2"></i>Editar Registro de Peso</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
          </div>
          <form id="formEditarRegistro">
            <div class="modal-body">
              <input type="hidden" id="edit_id" name="id">
              <div class="row">
                <div class="col-md-4 mb-3">
                  <label for="edit_turno" class="form-label">Turno</label>
                  <select class="form-select" id="edit_turno" name="turno" required>
                    <option value="">Seleccione turno</option>
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                  </select>
                </div>
                <div class="col-md-4 mb-3">
                  <label for="edit_producto_id" class="form-label">Producto</label>
                  <select class="form-select" id="edit_producto_id" name="producto_id" required>
                    {% for producto in productos %}
                      <option value="{{ producto.id }}">{{ producto.name }}</option>
                    {% endfor %}
                  </select>
                </div>
                <div class="col-md-4 mb-3">
                  <label for="edit_maquina_id" class="form-label">Máquina</label>
                  <select class="form-select" id="edit_maquina_id" name="maquina_id" required>
                    <option value="">Seleccione máquina</option>
                    {% for i in range(1, 16) %}
                      <option value="Maquina {{ i }}">Maquina {{ i }}</option>
                    {% endfor %}
                  </select>
                </div>
              </div>
              <div class="row">
                <div class="col-md-4 mb-3">
                  <label for="edit_peso_fijado" class="form-label">Peso Fijado</label>
                  <input type="number" class="form-control" id="edit_peso_fijado" name="peso_fijado" required>
                </div>
                <div class="col-md-4 mb-3">
                  <label for="edit_limite_superior" class="form-label">Límite Superior</label>
                  <input type="number" class="form-control" id="edit_limite_superior" name="limite_superior" required>
                </div>
                <div class="col-md-4 mb-3">
                  <label for="edit_control_promedio" class="form-label">Control Promedio</label>
                  <select class="form-select" id="edit_control_promedio" name="control_promedio" required>
                    <option value="">Seleccione</option>
                    <option value="ON">ON</option>
                    <option value="OFF">OFF</option>
                  </select>
                </div>
              </div>
              <div class="row">
                <div class="col-md-4 mb-3">
                  <label for="edit_compensacion" class="form-label">Compensación</label>
                  <input type="number" step="0.01" class="form-control" id="edit_compensacion" name="compensacion" required>
                </div>
                <div class="col-md-4 mb-3">
                  <label for="edit_intervalo_auto_cero" class="form-label">Intervalo Auto Cero</label>
                  <input type="number" class="form-control" id="edit_intervalo_auto_cero" name="intervalo_auto_cero" required>
                </div>
                <div class="col-md-4 mb-3">
                  <label for="edit_numero_estable" class="form-label">Número Estable</label>
                  <input type="number" class="form-control" id="edit_numero_estable" name="numero_estable" required>
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
              <button type="submit" class="btn btn-primary">Guardar Cambios</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Modal para ver/editar pesos individuales -->
    <div class="modal fade" id="modalVerPesos" tabindex="-1" aria-labelledby="verPesosLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <form id="formPesosIndividuales">
            <div class="modal-header bg-info text-white">
              <h5 class="modal-title" id="verPesosLabel"><i class="fas fa-balance-scale me-2"></i> Pesos Individuales</h5>
              <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body">
              <input type="hidden" id="pesos_registro_id" name="registro_id">
              <div class="mb-3 d-flex align-items-center">
                <label for="cantidad_pesos" class="form-label mb-0 me-2">Cantidad de Pesos</label>
                <input type="number" min="1" class="form-control me-2" style="max-width:120px;" id="cantidad_pesos" name="cantidad_pesos" required>
                <span id="porcentaje_pesos" class="badge bg-primary" style="font-size:1em;">0%</span>
              </div>
              <div id="inputsPesos"></div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
              <button type="submit" class="btn btn-info">Guardar Pesos</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Tabla de registros -->
    <div class="pesos-table-container">
        <div class="pesos-table-title">
            <i class="fas fa-database me-2"></i> Registros Pesos
        </div>
        <div class="pesos-table-responsive">
            <table class="table table-bordered table-hover pesos-table" id="pesosDatatable">
                <thead>
                    <tr>
                        <th>Máquina</th>
                        <th>Producto</th>
                        <th>Turno</th>
                        <th>Operador</th>
                        <th>Peso Fijado</th>
                        <th>Límite Superior</th>
                        <th>Control Promedio</th>
                        <th>Compensación</th>
                        <th>Intervalo Auto Cero</th>
                        <th>Número Estable</th>
                        <th>Pesos</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for r in registros %}
                      {% set data = r.data | fromjson %}
                      {% for captura in data.Capturas %}
                        <tr>
                          <td>{{ captura.maquina or '' }}</td>
                          <td>
                            {% set sabor_id = captura.sabor_id if 'sabor_id' in captura else None %}
                            {% if sabor_id %}
                              {% for producto in productos %}
                                {% if producto.id == sabor_id|int %}{{ producto.name }}{% endif %}
                              {% endfor %}
                            {% endif %}
                          </td>
                          <td>{{ captura.turno or '' }}</td>
                          <td>{{ captura.usuario or r.usuario or '' }}</td>
                          <td>{{ captura.peso_fijado or '' }}</td>
                          <td>{{ captura.limite_superior or '' }}</td>
                          <td>
                            {% if captura.control_promedio == 'ON' %}
                              <span class="badge bg-success">ON</span>
                            {% elif captura.control_promedio == 'OFF' %}
                              <span class="badge bg-danger">OFF</span>
                            {% else %}
                              {{ captura.control_promedio or '' }}
                            {% endif %}
                          </td>
                          <td>{{ captura.compensacion or '' }}</td>
                          <td>{{ captura.intervalo_auto_cero or '' }}</td>
                          <td>{{ captura.numero_estable or '' }}</td>
                          <td class="justify-content-center align-items-center">
                            <button class="btn btn-sm btn-info ver-pesos" data-id="{{ r.id }}" title="Ver Pesos">
                              <i class="fas fa-balance-scale"></i>
                            </button>
                          </td>
                          <td class="d-flex justify-content-center align-items-center">
                            <button class="btn btn-sm btn-warning editar-registro p-0 d-flex align-items-center justify-content-center" style="width:32px;height:32px;" data-id="{{ r.id }}" title="Editar">
                              <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-danger eliminar-registro p-0 d-flex align-items-center justify-content-center" style="width:32px;height:32px;" data-id="{{ r.id }}" title="Eliminar">
                              <i class="fas fa-trash"></i>
                            </button>
                          </td>
                        </tr>
                      {% endfor %}
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</main>
{% endblock %}

{% block extra_scripts %}
<script>
// Inicializar DataTable with scroll horizontal, without pagination, search, or order
$(document).ready(function() {
    $('#pesosDatatable').DataTable({
        scrollX: true,
        paging: false,
        searching: false,
        info: false,
        ordering: false,
        autoWidth: false,
        language: {
            url: '//cdn.datatables.net/plug-ins/1.10.24/i18n/Spanish.json'
        }
    });
});

// Eliminar registro
$(document).on('click', '.eliminar-registro', function () {
    const id = $(this).data('id');
    const $row = $(this).closest('tr');
    if (confirm('¿Está seguro que desea eliminar este registro? Esta acción no puede deshacerse.')) {
        $row.addClass('deleting-row');
        $.ajax({
            url: '/vaciar_registro_peso/' + id,
            method: 'POST',
            success: function (response) {
                if (response.success) {
                    location.reload();
                } else {
                    alert('Error al vaciar: ' + response.message);
                    $row.removeClass('deleting-row');
                }
            },
            error: function (error) {
                console.error('Error en la operación de vaciado', error);
                alert('Ha ocurrido un error al intentar vaciar el registro.');
                $row.removeClass('deleting-row');
            }
        });
    }
});

// Abrir modal de edición y cargar datos
$(document).on('click', '.editar-registro', function () {
    const id = $(this).data('id');
    $.get('/editar_registro_peso/' + id, function (data) {
        $('#edit_id').val(data.id);
        $('#edit_turno').val(data.turno);
        $('#edit_producto_id').val(data.producto_id);
        $('#edit_maquina_id').val(data.maquina_id);
        $('#edit_peso_fijado').val(data.peso_fijado);
        $('#edit_limite_superior').val(data.limite_superior);
        $('#edit_control_promedio').val(data.control_promedio);
        $('#edit_compensacion').val(data.compensacion);
        $('#edit_intervalo_auto_cero').val(data.intervalo_auto_cero);
        $('#edit_numero_estable').val(data.numero_estable);
        $('#modalEditarRegistro').modal('show');
    });
});

// Guardar cambios del registro editado
$('#formEditarRegistro').on('submit', function (e) {
    e.preventDefault();
    const id = $('#edit_id').val();
    const payload = {
        turno: $('#edit_turno').val(),
        producto_id: $('#edit_producto_id').val(),
        maquina_id: $('#edit_maquina_id').val(),
        peso_fijado: $('#edit_peso_fijado').val(),
        limite_superior: $('#edit_limite_superior').val(),
        control_promedio: $('#edit_control_promedio').val(),
        compensacion: $('#edit_compensacion').val(),
        intervalo_auto_cero: $('#edit_intervalo_auto_cero').val(),
        numero_estable: $('#edit_numero_estable').val()
    };
    $.ajax({
        url: '/editar_registro_peso/' + id,
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(payload),
        success: function (response) {
            if (response.success) {
                $('#modalEditarRegistro').modal('hide');
                location.reload();
            } else {
                alert('Error al guardar cambios: ' + (response.message || ''));
            }
        },
        error: function () {
            alert('Error al guardar cambios');
        }
    });
});

// Abrir modal de pesos individuales y cargar datos
$(document).on('click', '.ver-pesos', function () {
    const id = $(this).data('id');
    $('#pesos_registro_id').val(id);
    // Obtener los datos actuales
    $.get('/obtener_pesos_individuales/' + id, function (data) {
        $('#cantidad_pesos').val(data.cantidad || 1);
        renderInputsPesos(data.cantidad || 1, data.pesos || []);
        $('#modalVerPesos').modal('show');
    });
});

// Actualiza el porcentaje de campos llenados
function actualizarPorcentajePesos() {
    const total = parseInt($('#cantidad_pesos').val()) || 1;
    let llenos = 0;
    $('.peso-individual').each(function () {
        if ($(this).val() !== '' && !isNaN($(this).val())) {
            llenos++;
        }
    });
    const porcentaje = Math.round((llenos / total) * 100);
    $('#porcentaje_pesos').text(porcentaje + '%');
}

// Renderizar los inputs de pesos según la cantidad, conservando los valores digitados
function renderInputsPesos(cantidad, valores) {
    // Si ya hay inputs en pantalla, toma sus valores actuales
    let actuales = [];
    $('.peso-individual').each(function () {
        actuales.push($(this).val());
    });
    // Si no hay valores previos, usa los que vienen de la función (por ejemplo, al abrir el modal)
    if (actuales.length === 0) {
        actuales = valores.map(v => v !== undefined ? v : '');
    }
    let html = '<div class="row">';
    for (let i = 0; i < cantidad; i++) {
        let valor = actuales[i] !== undefined ? actuales[i] : (valores[i] !== undefined ? valores[i] : '');
        html += `
            <div class="col-6 col-md-4 mb-3">
                <div class="card p-2 shadow-sm">
                    <label class="form-label">Peso ${i + 1}:</label>
                    <input type="number" step="0.01" class="form-control peso-individual" name="peso_${i}" value="${valor}">
                </div>
            </div>
        `;
    }
    html += '</div>';
    $('#inputsPesos').html(html);
    actualizarPorcentajePesos();
    // Escuchar cambios en los nuevos inputs
    $('.peso-individual').on('input', actualizarPorcentajePesos);
}

// Cambiar la cantidad de inputs al modificar el número, conservando los valores digitados
$('#cantidad_pesos').on('input', function () {
    const cantidad = parseInt($(this).val()) || 1;
    renderInputsPesos(cantidad, []);
});

// Actualizar porcentaje al abrir el modal y al cambiar los valores
$(document).on('shown.bs.modal', '#modalVerPesos', function () {
    actualizarPorcentajePesos();
    $('.peso-individual').on('input', actualizarPorcentajePesos);
});

// Guardar los pesos individuales
$('#formPesosIndividuales').on('submit', function (e) {
    e.preventDefault();
    const id = $('#pesos_registro_id').val();
    const cantidad = parseInt($('#cantidad_pesos').val()) || 1;
    let pesos = [];
    $('.peso-individual').each(function () {
        pesos.push(parseFloat($(this).val()) || 0);
    });
    $.ajax({
        url: '/guardar_pesos_individuales/' + id,
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({ cantidad: cantidad, pesos: pesos }),
        success: function (resp) {
            if (resp.success) {
                $('#modalVerPesos').modal('hide');
                location.reload();
            } else {
                alert('Error al guardar: ' + (resp.message || ''));
            }
        },
        error: function () {
            alert('Error al guardar los pesos');
        }
    });
});

</script>
{% endblock %}