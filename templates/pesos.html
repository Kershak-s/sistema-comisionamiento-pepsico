{% extends "base.html" %}
{% block title %}Control de Pesos{% endblock %}
{% block page_title %}Control de Pesos{% endblock %}

{% block extra_styles %}
<style>
    .back-link {
        color: var(--pepsico-blue);
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        font-weight: 500;
        font-size: 0.9rem;
        margin-bottom: 1rem;
    }
    
    .back-link i {
        margin-right: 0.25rem;
    }

    .search-container {
        margin-bottom: 1.5rem;
    }
    
    .btn-create {
        background-color: var(--frito-lay-yellow);
        color: #333;
        font-weight: 500;
        transition: all 0.3s ease;
    }
    
    .btn-create:hover {
        background-color: #ffcc00;
        transform: translateY(-2px);
    }
    
    .dme-card {
        border-radius: 10px;
        overflow: hidden;
        transition: all 0.3s ease;
        margin-bottom: 1.5rem;
        border: none;
        box-shadow: 0 3px 10px rgba(0,0,0,0.05);
    }
    
    .dme-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 20px rgba(0,0,0,0.1);
    }
    
    .dme-card-header {
        background-color: var(--pepsico-blue);
        color: white;
        padding: 1rem;
    }
    
    .dme-card-body {
        padding: 1.5rem;
    }
    
    .dme-badge {
        font-size: 0.8rem;
        font-weight: 600;
        padding: 0.25rem 0.75rem;
        border-radius: 50px;
    }
    
    .dme-info-item {
        margin-bottom: 0.75rem;
        display: flex;
        align-items: center;
    }
    
    .dme-info-item i {
        width: 25px;
        color: var(--pepsico-blue);
        margin-right: 0.5rem;
    }
    
    .dme-actions {
        display: flex;
        gap: 0.5rem;
    }
    
    .no-exercises {
        background-color: #f8f9fa;
        border-radius: 10px;
        padding: 2rem;
        text-align: center;
        margin-top: 2rem;
    }
    
    .no-exercises i {
        font-size: 3rem;
        color: #6c757d;
        margin-bottom: 1rem;
    }
</style>
{% endblock %}
{% block content %}
<a href="{{ url_for('comicionamiento') }}" class="back-link">
    <i class="fas fa-arrow-left"></i> Volver a Comicionamiento
</a>

<div class="row mb-4">
    <div class="col-lg-8 col-md-6">
        <form action="" method="GET" class="search-container d-flex">
            <div class="input-group">
                <input type="text" class="form-control" placeholder="Buscar ejercicio de Peso..." name="q"
                    value="{{ query }}">
                <button class="btn btn-pepsico" type="submit">
                    <i class="fas fa-search"></i>
                </button>
            </div>
        </form>
    </div>
    <div class="col-lg-4 col-md-6 text-md-end">
        <button class="btn btn-create" data-bs-toggle="modal" data-bs-target="#nuevoPesoModal">
            <i class="fas fa-plus-circle me-2"></i> Crear Nuevo Ejercicio de Peso
        </button>
    </div>
</div>

{% if ejercicios %}
<div class="row">
    {% for ejercicio in ejercicios %}
    <div class="col-lg-6">
        <div class="dme-card card">
            <div class="dme-card-header d-flex justify-content-between align-items-center">
                <span class="fw-semibold" style="font-size: 1.15rem;">
                    {{ 'Pesos #' ~ ejercicio.id }}
                </span>
                <span class="dme-badge bg-light text-dark">
                    {{ ejercicio.fecha.strftime('%d/%m/%Y') }}
                </span>
            </div>
            <div class="dme-card-body">
                <div class="dme-info-item">
                    <i class="fas fa-cogs"></i>
                    <span><strong>Línea:</strong> {{ ejercicio.linea.name if ejercicio.linea else 'Sin línea' }}</span>
                </div>
                <hr>
                <div class="dme-actions">
                    <a href="{{ url_for('pesos_detail', id=ejercicio.id) }}" class="btn btn-primary flex-grow-1">
                        <i class="fas fa-eye me-1"></i> Completar Ejercicio
                    </a>
                    <form method="POST" action="{{ url_for('eliminar_registro_peso', id=ejercicio.id) }}" class="d-inline-block ms-2" onsubmit="return confirm('¿Está seguro de eliminar este ejercicio?');">
                        <button type="submit" class="btn btn-danger">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% else %}
<div class="no-exercises">
    <i class="fas fa-clipboard"></i>
    <h4>No hay ejercicios de peso disponibles</h4>
    <button class="btn btn-create mt-3 align-items-center" data-bs-toggle="modal" data-bs-target="#nuevoPesoModal">
        <i class="fas fa-plus-circle me-2"></i> Crear Nuevo Ejercicio de Peso
    </button>
</div>
{% endif %}

<!-- Modal para crear nuevo ejercicio de peso -->
<div class="modal fade" id="nuevoPesoModal" tabindex="-1" aria-labelledby="nuevoPesoModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form method="POST" action="{{ url_for('new_peso_ejercicio') }}">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="nuevoPesoModalLabel">Nuevo Ejercicio de Peso</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="bu_id" class="form-label">BU</label>
            <select class="form-select" id="bu_id" name="bu_id" required>
              <option value="">Seleccione un BU</option>
              {% for b in bus %}
              <option value="{{ b.id }}">{{ b.name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="mb-3">
            <label for="plant_id" class="form-label">Planta</label>
            <select class="form-select" id="plant_id" name="plant_id" required>
              <option value="">Seleccione una planta</option>
              {% for p in plantas %}
              <option value="{{ p.id }}" data-bu="{{ p.bu_id }}">{{ p.name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="mb-3">
            <label for="linea_id" class="form-label">Línea</label>
            <select class="form-select" id="linea_id" name="linea_id" required>
              <option value="">Seleccione una línea</option>
              {% for l in lineas %}
              <option value="{{ l.id }}" data-plant="{{ l.plant_id }}">{{ l.name }}</option>
              {% endfor %}
            </select>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-primary">Crear ejercicio</button>
        </div>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Filtrar plantas por BU
    document.getElementById('bu_id').addEventListener('change', function() {
        var buId = this.value;
        var plantSelect = document.getElementById('plant_id');
        var lineSelect = document.getElementById('linea_id');
        // Mostrar solo plantas del BU seleccionado
        Array.from(plantSelect.options).forEach(function(opt) {
            if (!opt.value) return opt.style.display = '';
            opt.style.display = (opt.getAttribute('data-bu') === buId) ? '' : 'none';
        });
        plantSelect.value = '';
        // Limpiar líneas
        Array.from(lineSelect.options).forEach(function(opt) {
            if (!opt.value) return opt.style.display = '';
            opt.style.display = 'none';
        });
        lineSelect.value = '';
    });

    // Filtrar líneas por planta
    document.getElementById('plant_id').addEventListener('change', function() {
        var plantId = this.value;
        var lineSelect = document.getElementById('linea_id');
        Array.from(lineSelect.options).forEach(function(opt) {
            if (!opt.value) return opt.style.display = '';
            opt.style.display = (opt.getAttribute('data-plant') === plantId) ? '' : 'none';
        });
        lineSelect.value = '';
    });

    // Al abrir el modal, limpiar selects
    document.getElementById('nuevoPesoModal').addEventListener('show.bs.modal', function () {
        document.getElementById('bu_id').value = '';
        document.getElementById('plant_id').value = '';
        document.getElementById('linea_id').value = '';
        Array.from(document.getElementById('plant_id').options).forEach(function(opt) {
            opt.style.display = '';
        });
        Array.from(document.getElementById('linea_id').options).forEach(function(opt) {
            opt.style.display = '';
        });
    });
});
</script>
{% endblock %}