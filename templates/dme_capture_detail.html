{% extends "base.html" %}

{% block title %}Detalle de Captura DME - PepsiCo{% endblock %}

{% block page_title %}Captura DME - Ejercicio #{{ exercise.id }}{% endblock %}

{% block extra_styles %}
<style>
    .back-link {
        color: var(--pepsico-blue);
        text-decoration: none;
        display: inline-flex;
        align-items: center;
        font-weight: 500;
        font-size: 0.9rem;
        margin-bottom: 1rem;
    }

    .back-link i {
        margin-right: 0.25rem;
    }

    .capture-header {
        background-color: white;
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 2rem;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    }

    .exercise-info {
        display: flex;
        flex-wrap: wrap;
        margin-top: 1rem;
    }

    .info-item {
        flex: 1 1 200px;
        margin-bottom: 1rem;
        padding-right: 1rem;
    }

    .info-label {
        font-size: 0.85rem;
        color: #6c757d;
        margin-bottom: 0.25rem;
    }

    .info-value {
        font-weight: 600;
        font-size: 1.1rem;
    }

    .btn-action {
        padding: 0.6rem 1.2rem;
        border-radius: 50px;
        font-weight: 500;
        transition: all 0.3s ease;
    }

    .btn-action:hover {
        transform: translateY(-2px);
    }

    .defects-container {
        background-color: white;
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        margin-bottom: 2rem;
    }

    .form-floating {
        margin-bottom: 1rem;
    }

    .modal-title {
        color: var(--pepsico-blue);
    }

    .defect-badge {
        display: inline-block;
        padding: 0.35rem 0.75rem;
        border-radius: 50px;
        font-size: 0.85rem;
        font-weight: 600;
        margin-right: 0.5rem;
        margin-bottom: 0.5rem;
    }

    .defect-card {
        border: 1px solid #e9ecef;
        border-radius: 10px;
        margin-bottom: 1.5rem;
        transition: all 0.3s ease;
        overflow: hidden;
    }

    .defect-card:hover {
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }

    .defect-header {
        background-color: #f8f9fa;
        padding: 1rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid #e9ecef;
    }

    .defect-body {
        padding: 1.5rem;
    }

    .defect-info-item {
        margin-bottom: 0.75rem;
    }

    .defect-info-label {
        font-size: 0.85rem;
        color: #6c757d;
        margin-bottom: 0.25rem;
    }

    .defect-actions {
        display: flex;
        justify-content: flex-end;
        margin-top: 1rem;
    }

    .no-defects {
        text-align: center;
        padding: 3rem 1rem;
        background-color: #f8f9fa;
        border-radius: 10px;
    }

    .no-defects i {
        font-size: 3rem;
        color: #adb5bd;
        margin-bottom: 1rem;
    }

    .form-title {
        margin-bottom: 1.5rem;
        color: var(--pepsico-blue);
        font-weight: 600;
    }

    .required-indicator {
        color: #dc3545;
        margin-left: 3px;
    }

    .defect-image {
        margin-top: 1rem;
        border-radius: 8px;
        border: 1px solid #dee2e6;
        overflow: hidden;
    }

    .defect-image img {
        max-width: 100%;
        max-height: 300px;
        object-fit: contain;
    }

    .capture-table-container {
        margin-bottom: 20px;
        box-shadow: 0 4px 16px rgba(76, 175, 80, 0.08);
    }

    .capture-title {
        background: linear-gradient(90deg, #0057a8 0%, #3984c9 100%);
        color: white;
        font-weight: 600;
        font-size: 1.1rem;
        padding: 0.75rem;
        border-radius: 12px 12px 0 0;
        margin-bottom: 1rem;
    }

    .excel-header-row {
        background: linear-gradient(90deg, #0057a8 0%, #3984c9 100%);
        color: #fff;
    }

    .table-striped tbody tr:nth-of-type(odd) {
        background-color: #f2f2f2;
    }

    .table-striped tbody tr:nth-of-type(even) {
        background-color: #ffffff;
    }

    .cantidad-input-group .btn {
        border-radius: 0 !important;
        transition: background 0.2s, color 0.2s;
        padding-left: 0.5rem;
        padding-right: 0.5rem;
    }

    .cantidad-input-group .btn:active, .cantidad-input-group .btn:focus {
        background: #0057a8 !important;
        color: #fff !important;
    }

    .cantidad-defecto-input:focus {
        box-shadow: 0 0 0 2px #3984c933;
        border-color: #3984c9;
        background: #e3f0ff;
    }

    /* Ocultar flechas del input number en todos los navegadores */
    .no-arrows::-webkit-outer-spin-button,
    .no-arrows::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }
    .no-arrows[type=number] {
        -moz-appearance: textfield;
    }
</style>
{% endblock %}

{% block content %}
<!-- Encabezado de la Captura -->
<a href="{{ url_for('view_dme_exercise', exercise_id=exercise.id) }}" class="back-link">
    <i class="fas fa-arrow-left"></i> Volver
</a>
<div class="capture-header">
    <div class="d-flex justify-content-between align-items-center">
        <h4 class="mb-0">
            <i class="fas fa-camera me-2"></i>
            Captura DME - Máquina: {{ captura.maquina }}
        </h4>
    </div>

    <div class="exercise-info">
        <div class="info-item">
            <div class="info-label">Unidad de Negocio</div>
            <div class="info-value">{{ exercise.bu.name }}</div>
        </div>
        <div class="info-item">
            <div class="info-label">Planta</div>
            <div class="info-value">{{ exercise.plant.name }}</div>
        </div>
        <div class="info-item">
            <div class="info-label">Línea</div>
            <div class="info-value">{{ exercise.linea }}</div>
        </div>
        <div class="info-item">
            <div class="info-label">Fecha y Hora de Captura</div>
            <div class="info-value">{{ captura.fecha_hora|fromiso|strftime('%d/%m/%Y %H:%M') }}</div>
        </div>
    </div>

    <hr>

    <div class="text-center">
        <h5 class="mb-3">FORMATO DE ANÁLISIS DE "DME"</h5>
        <p class="text-muted mb-1">{{ exercise.bu.name }} - {{ exercise.plant.name }} - {{ exercise.linea }} - {{
            captura.maquina }}</p>
        <p class="text-muted"><strong>DME #{{ exercise.id }}</strong> ({{ exercise.created_at.strftime('%d/%m/%Y') }})
        </p>
    </div>

    <div class="text-end mt-3">
        <button type="button" class="btn btn-action btn-frito-lay" data-bs-toggle="modal"
            data-bs-target="#addDefectModal">
            <i class="fas fa-plus-circle me-2"></i>Agregar Defecto
        </button>
    </div>
</div>

<!-- Contenedor de Defectos -->
<div class="defects-container capture-table-container" style="margin-bottom: 20px; box-shadow: 0 4px 16px rgba(76, 175, 80, 0.08);">
    <div class="capture-title" style="background: linear-gradient(90deg, #0057a8 0%, #3984c9 100%); color: white; font-weight: 600; font-size: 1.1rem;">
        <i class="fas fa-exclamation-triangle me-2"></i> Defectos Registrados
    </div>

    {% if captura.defectos and captura.defectos|length > 0 %}
    <div class="table-responsive">
        <table class="table table-bordered table-striped align-middle mb-0">
            <thead>
                <tr class="excel-header-row" style="background: linear-gradient(90deg, #0057a8 0%, #3984c9 100%); color: #fff;">
                    <th style="background: none; color: #fff;">Tipo</th>
                    <th style="background: none; color: #fff;">Cantidad</th>
                    <th style="background: none; color: #fff;">Fecha y Hora</th>
                    <th style="background: none; color: #fff;">Comentarios</th>
                    <th style="background: none; color: #fff;">Hora Relativa</th>
                    <th style="background: none; color: #fff;">Imagen</th>
                    <th style="background: none; color: #fff;">Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for defecto in captura.defectos|sort(attribute='fecha_hora', reverse=true) %}
                <tr>
                    <td >{{ defecto.tipo }}</td>
                    <td >
                        <div class="input-group cantidad-input-group" style="width: 110px;">
                            <button class="btn btn-primary btn-sm btn-restar-cantidad" type="button" tabindex="-1" title="Restar">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <input 
                                type="number" 
                                class="form-control cantidad-defecto-input text-center fw-bold border-primary no-arrows" 
                                value="{{ defecto.cantidad }}" 
                                min="1"
                                data-defecto-id="{{ defecto.id }}"
                                data-capture-id="{{ captura.id }}"
                                style="width: 45px; background: none; color: #0057a8; border: none;"
                            >
                            <button class="btn btn-primary btn-sm btn-sumar-cantidad" type="button" tabindex="-1" title="Sumar">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                    </td>
                    <td >{{ defecto.fecha_hora|fromiso|strftime('%d/%m/%Y %H:%M') }}</td>
                    <td>
                        {% if defecto.comentario %}
                            {{ defecto.comentario }}
                        {% else %}
                            <span class="text-muted">-</span>
                        {% endif %}
                    </td>
                    <td>
                        <span class="badge bg-primary">{{ defecto.hora_relativa }}</span>
                    </td>
                    <td>
                        {% if defecto.imagen %}
                        <button class="btn btn-sm btn-primary text-light" type="button" data-bs-toggle="collapse" data-bs-target="#imgCollapse{{ loop.index }}" aria-expanded="false" aria-controls="imgCollapse{{ loop.index }}">
                            Ver Imagen
                        </button>
                        <div class="collapse mt-2" id="imgCollapse{{ loop.index }}">
                            <div class="defect-image">
                                <img src="{{ defecto.imagen }}" alt="Imagen del defecto" class="img-fluid">
                            </div>
                        </div>
                        {% else %}
                        <span class="text-muted">Sin imagen</span>
                        {% endif %}
                    </td>
                    <td>
                        <form action="{{ url_for('delete_dme_defect', exercise_id=exercise.id, capture_id=captura.id, defect_id=defecto.id) }}"
                            method="POST" onsubmit="return confirm('¿Está seguro de eliminar este defecto?')">
                            <button type="submit" class="btn btn-danger btn-sm delete-capture" title="Eliminar defecto">
                                <i class="fas fa-trash-alt me-1"></i> Eliminar
                            </button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="no-defects">
        <i class="fas fa-exclamation-circle d-block"></i>
        <h5>No hay defectos registrados</h5>
        <p class="text-muted">Registre un nuevo defecto para comenzar el monitoreo.</p>
        <button type="button" class="btn btn-frito-lay mt-3" data-bs-toggle="modal" data-bs-target="#addDefectModal">
            <i class="fas fa-plus-circle me-2"></i>Agregar Defecto
        </button>
    </div>
    {% endif %}
</div>

<!-- Modal para Agregar Defecto -->
<div class="modal fade" id="addDefectModal" tabindex="-1" aria-labelledby="addDefectModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addDefectModalLabel">
                    <i class="fas fa-plus-circle me-2"></i>Agregar Nuevo Defecto
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form action="{{ url_for('add_dme_defect', exercise_id=exercise.id, capture_id=captura.id) }}"
                    method="POST" id="defectForm" enctype="multipart/form-data">
                    <div class="row mb-3">
                        <div class="col-md-12">
                            <label for="tipo_defecto" class="form-label">Tipo de Defecto<span
                                    class="required-indicator">*</span></label>
                            <select class="form-select" id="tipo_defecto" name="tipo_defecto" required>
                                <option value="" selected disabled>Seleccionar tipo de defecto</option>
                                {% for tipo in defect_types %}
                                <option value="{{ tipo }}">{{ tipo }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label for="cantidad" class="form-label">Cantidad de Defectos<span
                                    class="required-indicator">*</span></label>
                            <input type="number" class="form-control" id="cantidad" name="cantidad" min="1" value="1"
                                required>
                        </div>
                        <div class="col-md-4">
                            <label for="hora_captura" class="form-label">Hora de Captura<span
                                    class="required-indicator">*</span></label>
                            <input type="number" class="form-control" id="hora_captura" name="hora_captura" min="1"
                                max="24" value="1" required>
                            <small class="form-text text-muted">Ingrese la hora (1 a 24) en la que ocurrió el
                                defecto</small>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Fecha y Hora</label>
                            <input type="text" class="form-control" value="{{ now.strftime('%d/%m/%Y %H:%M') }}"
                                readonly disabled>
                            <small class="form-text text-muted">Se registrará automáticamente</small>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="comentario" class="form-label">Comentarios</label>
                        <textarea class="form-control" id="comentario" name="comentario" rows="3"
                            placeholder="Agregue comentarios adicionales sobre el defecto..."></textarea>
                    </div>

                    <div class="mb-3">
                        <label for="imagen" class="form-label">Imagen del defecto</label>
                        <input type="file" class="form-control" id="imagen" name="imagen" accept="image/*">
                        <small class="form-text text-muted">Formatos permitidos: JPG, PNG, GIF. Tamaño máximo:
                            5MB</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="submit" form="defectForm" class="btn btn-frito-lay">
                    <i class="fas fa-check me-1"></i> Guardar Defecto
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        console.log('DME Capture Detail page loaded');

        // Vista previa de la imagen
        const imagenInput = document.getElementById('imagen');
        imagenInput.onchange = function () {
            if (this.files && this.files[0]) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    if (document.getElementById('preview-container')) {
                        document.getElementById('preview-img').src = e.target.result;
                    } else {
                        const previewContainer = document.createElement('div');
                        previewContainer.id = 'preview-container';
                        previewContainer.className = 'mt-3 p-2 border rounded';

                        const previewTitle = document.createElement('p');
                        previewTitle.className = 'mb-2 text-muted';
                        previewTitle.textContent = 'Vista previa:';

                        const previewImg = document.createElement('img');
                        previewImg.id = 'preview-img';
                        previewImg.src = e.target.result;
                        previewImg.className = 'img-fluid rounded';
                        previewImg.style.maxHeight = '200px';

                        previewContainer.appendChild(previewTitle);
                        previewContainer.appendChild(previewImg);

                        imagenInput.parentNode.appendChild(previewContainer);
                    }
                }
                reader.readAsDataURL(this.files[0]);
            }
        };

        // Botones + y -
        document.querySelectorAll('.btn-restar-cantidad').forEach(btn => {
            btn.addEventListener('click', function() {
                const input = this.parentNode.querySelector('.cantidad-defecto-input');
                let valor = parseInt(input.value) || 1;
                if (valor > 1) {
                    input.value = valor - 1;
                    input.dispatchEvent(new Event('change'));
                }
            });
        });
        document.querySelectorAll('.btn-sumar-cantidad').forEach(btn => {
            btn.addEventListener('click', function() {
                const input = this.parentNode.querySelector('.cantidad-defecto-input');
                let valor = parseInt(input.value) || 1;
                input.value = valor + 1;
                input.dispatchEvent(new Event('change'));
            });
        });

        // Guardar cantidad en tiempo real
        document.querySelectorAll('.cantidad-defecto-input').forEach(input => {
            input.addEventListener('change', function() {
                const defectoId = this.dataset.defectoId;
                const captureId = this.dataset.captureId;
                const cantidad = this.value;
                fetch(`{{ url_for('update_dme_defecto_cantidad', exercise_id=exercise.id, capture_id=captura.id) }}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        defecto_id: defectoId,
                        cantidad: cantidad
                    })
                })
                .then(res => res.json())
                .then(data => {
                    if (!data.success) {
                        alert('Error al actualizar: ' + (data.message || ''));
                    }
                })
                .catch(() => alert('Error de red al actualizar'));
            });
        });
    });
</script>
{% endblock %}